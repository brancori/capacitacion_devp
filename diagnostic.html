<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diagn√≥stico de Red - Aula Corporativa</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }
    .test-section {
      margin-bottom: 25px;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .test-section h2 {
      color: #555;
      font-size: 18px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    .status.pending { background: #ffd700; color: #333; }
    .status.success { background: #4caf50; color: white; }
    .status.error { background: #f44336; color: white; }
    .status.warning { background: #ff9800; color: white; }
    .result {
      margin-top: 10px;
      padding: 12px;
      background: white;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
      line-height: 1.6;
      max-height: 300px;
      overflow-y: auto;
    }
    .result pre {
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: background 0.3s;
    }
    button:hover { background: #5568d3; }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    .error-box {
      background: #ffebee;
      border-left: 4px solid #f44336;
      padding: 15px;
      margin-top: 10px;
      border-radius: 4px;
    }
    .summary {
      margin-top: 30px;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
    }
    .summary h3 {
      color: #333;
      margin-bottom: 15px;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Diagn√≥stico de Red Corporativa</h1>
    <p class="subtitle">Esta herramienta detecta bloqueos de firewall y problemas de conectividad</p>

    <div class="info-box">
      <strong>üìç Ubicaci√≥n:</strong> <span id="location">Detectando...</span><br>
      <strong>üåê Navegador:</strong> <span id="browser">Detectando...</span><br>
      <strong>üîí Cookies/Storage:</strong> <span id="storage">Detectando...</span>
    </div>

    <button id="runTests" onclick="runAllTests()">‚ñ∂Ô∏è Ejecutar Diagn√≥stico Completo</button>

    <div id="tests"></div>

    <div class="summary" id="summary" style="display: none;">
      <h3>üìä Resumen de Resultados</h3>
      <div id="summaryContent"></div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://hvwygpnuunuuylzondxt.supabase.co';
    const PROXY_URL = '/api';
    
    let testResults = {};

    // Detectar informaci√≥n del entorno
    function detectEnvironment() {
      const ua = navigator.userAgent;
      let browser = 'Desconocido';
      if (ua.includes('Firefox')) browser = 'Firefox';
      else if (ua.includes('Chrome')) browser = 'Chrome';
      else if (ua.includes('Safari')) browser = 'Safari';
      else if (ua.includes('Edge')) browser = 'Edge';
      
      document.getElementById('browser').textContent = browser;
      document.getElementById('location').textContent = window.location.hostname;
      
      // Test storage
      try {
        localStorage.setItem('test', '1');
        localStorage.removeItem('test');
        document.getElementById('storage').innerHTML = '<span class="status success">Habilitado</span>';
      } catch (e) {
        document.getElementById('storage').innerHTML = '<span class="status error">Bloqueado</span>';
      }
    }

    // Crear secci√≥n de test
    function createTestSection(id, title) {
      const section = document.createElement('div');
      section.className = 'test-section';
      section.id = `test-${id}`;
      section.innerHTML = `
        <h2>
          ${title}
          <span class="status pending" id="status-${id}">Esperando...</span>
        </h2>
        <div class="result" id="result-${id}">No ejecutado</div>
      `;
      document.getElementById('tests').appendChild(section);
    }

    // Actualizar estado
    function updateStatus(id, status, message, details = null) {
      const statusEl = document.getElementById(`status-${id}`);
      const resultEl = document.getElementById(`result-${id}`);
      
      statusEl.className = `status ${status}`;
      statusEl.textContent = status === 'success' ? '‚úì OK' : 
                            status === 'error' ? '‚úó Bloqueado' : 
                            status === 'warning' ? '‚ö† Advertencia' : 
                            '‚è≥ Probando...';
      
      let html = `<strong>${message}</strong>`;
      if (details) {
        html += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
      }
      resultEl.innerHTML = html;
      
      testResults[id] = { status, message, details };
    }

    // Test 1: DNS Resolution
    async function testDNS() {
      updateStatus('dns', 'pending', 'Resolviendo DNS...');
      try {
        const start = Date.now();
        const response = await fetch(`${SUPABASE_URL}/rest/v1/`, { method: 'HEAD' });
        const time = Date.now() - start;
        updateStatus('dns', 'success', `DNS resuelto correctamente (${time}ms)`, {
          url: SUPABASE_URL,
          status: response.status,
          tiempo: `${time}ms`
        });
      } catch (error) {
        updateStatus('dns', 'error', 'No se puede resolver el dominio de Supabase', {
          error: error.message,
          tipo: error.name,
          posible_causa: 'Firewall bloqueando DNS o dominio en lista negra'
        });
      }
    }

    // Test 2: REST API Direct
    async function testRESTDirect() {
      updateStatus('rest-direct', 'pending', 'Probando conexi√≥n directa a REST API...');
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
          method: 'GET',
          headers: {
            'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2d3lncG51dW51dXlsem9uZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDUzMTEsImV4cCI6MjA3NjEyMTMxMX0.FxjCX9epT_6LgWGdzdPhRUTP2vn4CLdixRqpFMRZK70',
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          updateStatus('rest-direct', 'success', 'Conexi√≥n directa funcional', {
            status: response.status,
            headers: Object.fromEntries(response.headers.entries())
          });
        } else {
          updateStatus('rest-direct', 'warning', `Respuesta no OK: ${response.status}`, {
            status: response.status,
            statusText: response.statusText
          });
        }
      } catch (error) {
        updateStatus('rest-direct', 'error', 'Conexi√≥n REST bloqueada por firewall', {
          error: error.message,
          recomendacion: 'Usar proxy PHP obligatorio'
        });
      }
    }

    // Test 3: Edge Functions
    async function testEdgeFunctions() {
      updateStatus('edge-functions', 'pending', 'Probando Edge Functions...');
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/custom-login`, {
          method: 'OPTIONS',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const corsHeaders = response.headers.get('access-control-allow-origin');
        
        if (corsHeaders) {
          updateStatus('edge-functions', 'success', 'Edge Functions accesibles', {
            cors: corsHeaders,
            status: response.status
          });
        } else {
          updateStatus('edge-functions', 'warning', 'Edge Functions sin CORS correcto', {
            status: response.status,
            recomendacion: 'Verificar headers CORS en la funci√≥n'
          });
        }
      } catch (error) {
        updateStatus('edge-functions', 'error', 'Edge Functions bloqueadas', {
          error: error.message,
          recomendacion: 'Necesitas proxy para Edge Functions'
        });
      }
    }

    // Test 4: WebSocket (Realtime)
    async function testWebSocket() {
      updateStatus('websocket', 'pending', 'Probando conexiones WebSocket...');
      try {
        const ws = new WebSocket('wss://hvwygpnuunuuylzondxt.supabase.co/realtime/v1/websocket');
        
        const timeout = setTimeout(() => {
          ws.close();
          updateStatus('websocket', 'error', 'WebSocket timeout', {
            recomendacion: 'Firewall bloquea WSS. Desactiva Realtime.'
          });
        }, 5000);
        
        ws.onopen = () => {
          clearTimeout(timeout);
          ws.close();
          updateStatus('websocket', 'success', 'WebSocket funcional', {
            estado: 'Conectado correctamente'
          });
        };
        
        ws.onerror = (error) => {
          clearTimeout(timeout);
          updateStatus('websocket', 'error', 'WebSocket bloqueado por firewall', {
            recomendacion: 'Desactiva Realtime en cliente Supabase'
          });
        };
      } catch (error) {
        updateStatus('websocket', 'error', 'WebSocket no disponible', {
          error: error.message
        });
      }
    }

    // Test 5: Proxy PHP
    async function testProxy() {
      updateStatus('proxy', 'pending', 'Probando proxy PHP...');
      try {
        const response = await fetch(`${PROXY_URL}/rest/v1/`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        if (response.ok) {
          updateStatus('proxy', 'success', 'Proxy PHP funcional', {
            status: response.status,
            recomendacion: 'Usar proxy para todas las peticiones'
          });
        } else {
          updateStatus('proxy', 'warning', `Proxy responde con ${response.status}`, {
            status: response.status
          });
        }
      } catch (error) {
        updateStatus('proxy', 'error', 'Proxy no disponible', {
          error: error.message,
          recomendacion: 'Configurar proxy PHP obligatorio'
        });
      }
    }

    // Test 6: CORS Preflight
    async function testCORS() {
      updateStatus('cors', 'pending', 'Probando CORS...');
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/`, {
          method: 'OPTIONS',
          headers: {
            'Access-Control-Request-Method': 'POST',
            'Access-Control-Request-Headers': 'content-type'
          }
        });
        
        const allowOrigin = response.headers.get('access-control-allow-origin');
        const allowHeaders = response.headers.get('access-control-allow-headers');
        
        updateStatus('cors', allowOrigin ? 'success' : 'error', 
          allowOrigin ? 'CORS configurado correctamente' : 'CORS bloqueado', {
          'allow-origin': allowOrigin,
          'allow-headers': allowHeaders,
          status: response.status
        });
      } catch (error) {
        updateStatus('cors', 'error', 'Preflight bloqueado', {
          error: error.message
        });
      }
    }

    // Ejecutar todos los tests
    async function runAllTests() {
      document.getElementById('runTests').disabled = true;
      document.getElementById('tests').innerHTML = '';
      document.getElementById('summary').style.display = 'none';
      testResults = {};
      
      createTestSection('dns', '1. Resoluci√≥n DNS');
      createTestSection('rest-direct', '2. REST API (Directo)');
      createTestSection('edge-functions', '3. Edge Functions');
      createTestSection('websocket', '4. WebSocket/Realtime');
      createTestSection('proxy', '5. Proxy PHP');
      createTestSection('cors', '6. CORS Preflight');
      
      await testDNS();
      await new Promise(r => setTimeout(r, 500));
      await testRESTDirect();
      await new Promise(r => setTimeout(r, 500));
      await testEdgeFunctions();
      await new Promise(r => setTimeout(r, 500));
      await testWebSocket();
      await new Promise(r => setTimeout(r, 500));
      await testProxy();
      await new Promise(r => setTimeout(r, 500));
      await testCORS();
      
      showSummary();
      document.getElementById('runTests').disabled = false;
    }

    // Mostrar resumen
    function showSummary() {
      const summary = document.getElementById('summary');
      const content = document.getElementById('summaryContent');
      
      let html = '';
      let blocked = 0;
      let working = 0;
      
      Object.entries(testResults).forEach(([key, result]) => {
        if (result.status === 'error') blocked++;
        if (result.status === 'success') working++;
        
        html += `
          <div class="summary-item">
            <span>${key}</span>
            <span class="status ${result.status}">${result.message}</span>
          </div>
        `;
      });
      
      content.innerHTML = html;
      
      if (blocked > 2) {
        content.innerHTML += `
          <div class="error-box" style="margin-top: 20px;">
            <strong>‚ö†Ô∏è FIREWALL CORPORATIVO DETECTADO</strong><br>
            Se encontraron ${blocked} bloqueos. Tu red corporativa est√° bloqueando conexiones directas a Supabase.<br><br>
            <strong>Soluci√≥n:</strong> Implementar proxy PHP completo para TODAS las peticiones.
          </div>
        `;
      }
      
      summary.style.display = 'block';
    }

    // Inicializar
    detectEnvironment();
  </script>
</body>
</html>