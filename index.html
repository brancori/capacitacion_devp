<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#1a0b2e" />
  <title>Aula Corporativa - Acceso Seguro</title>
  <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">
  <link  rel="stylesheet" href="./index.css"> </link>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
  <!-- Animated Background -->
  <div class="bg-animated">
    <div class="bg-orbs">
      <div class="orb"></div>
      <div class="orb"></div>
      <div class="orb"></div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container">
    <div class="main-card" id="mainCard">
      
      <!-- LEFT: Branding Section -->
      <div class="brand-section">
        <div class="logo-container">
          <div class="logo-icon" id="logoIcon">AC</div>
          <i class="fas fa-graduation-cap"></i>
          <div class="logo-text" id="logoText"> Aula Corporativa</div>
        </div>

        <div class="brand-content">
          <h1 class="brand-title" id="brandTitle">Â¡Bienvenido!</h1>
          <p class="brand-description" id="brandDescription">
            Accede a tu plataforma de capacitaciÃ³n corporativa. Aprende, y mejorar tus habilidades profesionales.
          </p>
          <div class="brand-features" id="brandFeatures"></div>
        </div>

        <div class="brand-footer">
          <small>&copy; <span id="currentYear"></span> Aula Corporativa. Todos los derechos reservados.</small>
        </div>
      </div>

      <!-- RIGHT: Form Section -->
      <div class="form-section">
        <!-- Tab Navigation -->
        <nav class="tab-nav" role="tablist" aria-label="Tipo de usuario">
          <button class="tab-btn active" role="tab" aria-selected="true" data-tab="employees" id="tabEmployees">
            Trabajadores
          </button>
          <button class="tab-btn" role="tab" aria-selected="false" data-tab="contractors" id="tabContractors">
            Contratistas
          </button>
        </nav>

        <!-- Form Container -->
        <div class="form-container">
          
          <!-- Employees Form -->
          <form class="login-form active" id="formEmployees" role="tabpanel" aria-labelledby="tabEmployees">
            <div>
              <h2 class="form-title">Iniciar SesiÃ³n</h2>
              <p class="form-subtitle">Ingresa tu correo o ID</p>
            </div>

            <div class="form-group">
              <label class="form-label" for="empUsername" id="labelEmpUser">Usuario</label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
                <input 
                  type="text" 
                  id="empUsername" 
                  class="form-input" 
                  placeholder="usuario@empresa.com"
                  autocomplete="username"
                  required
                />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="empPassword" id="labelEmpPass">ContraseÃ±a</label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <input 
                  type="password" 
                  id="empPassword" 
                  class="form-input" 
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  autocomplete="current-password"
                  required
                />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-block" id="btnLoginEmp">
                <span>Ingresar</span>
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
              </button>
            </div>

            <div class="form-footer">
              <a href="#" class="form-link" id="forgotEmp">Â¿Olvidaste tu contraseÃ±a?</a>
              <div>Â¿No tienes cuenta? <a href="#" class="form-link" id="registerEmp">RegÃ­strate aquÃ­</a></div>
            </div>
          </form>

          <!-- Contractors Form -->
          <form class="login-form" id="formContractors" role="tabpanel" aria-labelledby="tabContractors">
            <div>
              <h2 class="form-title">Acceso Contratistas</h2>
              <p class="form-subtitle">Ingresa tu correo</p>
            </div>

            <div class="form-group">
              <label class="form-label" for="conUsername" id="labelConUser">ID Contratista</label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V8a2 2 0 00-2-2h-5m-4 0V5a2 2 0 114 0v1m-4 0a2 2 0 104 0m-5 8a2 2 0 100-4 2 2 0 000 4zm0 0c1.306 0 2.417.835 2.83 2M9 14a3.001 3.001 0 00-2.83 2M15 11h3m-3 4h2"/>
                </svg>
                <input 
                  type="text" 
                  id="conUsername" 
                  class="form-input" 
                  placeholder="contratista@empresa.com"
                  autocomplete="username"
                  required
                />
              </div>
            </div>

            <div class="form-group">
              <label class="form-label" for="conPassword" id="labelConPass">ContraseÃ±a</label>
              <div class="input-wrapper">
                <svg class="input-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                </svg>
                <input 
                  type="password" 
                  id="conPassword" 
                  class="form-input" 
                  placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                  autocomplete="current-password"
                  required
                />
              </div>
            </div>

            <div class="form-actions">
              <button type="submit" class="btn btn-primary btn-block" id="btnLoginCon">
                <span>Ingresar</span>
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"/>
                </svg>
              </button>
            </div>

            <div class="form-footer">
              <a href="#" class="form-link" id="supportCon">Soporte para contratistas</a>
              <div>Â¿Problemas de acceso? <a href="#" class="form-link" id="helpCon">Contactar supervisor</a></div>
            </div>
          </form>

        </div>
      </div>

    </div>
  </div>
  <!-- MODAL PROFILE-->
  <div>
    <h3>Mi Perfil </h3>
    <div>
      <span>Foto de perfil</span>
      <input type="image" src="https://via.placeholder.com/150" alt="Foto de perfil" />
    </div>
  </div>



  <!-- Modal Root -->
  <div id="modalRoot" role="dialog" aria-live="polite"></div>
<div id="modalRoot"></div>
  <!-- Main JavaScript -->
<script>
  (function() {
    'use strict';

    const SUPABASE_URL = 'https://hvwygpnuunuuylzondxt.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2d3lncG51dW51dXlsem9uZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDUzMTEsImV4cCI6MjA3NjEyMTMxMX0.FxjCX9epT_6LgWGdzdPhRUTP2vn4CLdixRqpFMRZK70';

    // El cliente de Supabase ahora estÃ¡ disponible globalmente
    // La variable 'supabase' se usarÃ¡ para todas las llamadas (login, register, etc.)
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURATION & DEFAULTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const DEFAULTS = {
      companyName: "Aula Corporativa",
      logoText: "AC",
      logoUrl: null,
      tagline: "Â¡Bienvenido!",
      description: "Accede a tu plataforma de capacitaciÃ³n corporativa. Aprende, crece y alcanza tus objetivos profesionales.",
      
      bgPage: "#141E30",
      textPage: "#ffffff",
      primaryColor: "#234B95",
      secondaryColor: "#1F3F7A",
      
      bgBrand: "#ffffff",
      textBrand: "#33374d",
      
      bgForm: "rgba(0, 0, 0, 0.3)",
      textForm: "#ffffff",
      inputTheme: "dark",

      bgSuccess: "linear-gradient(135deg, #06d6a0, #1b9aaa)",
      bgError: "linear-gradient(135deg, #ef476f, #b30f20)",
      bgOverlay: "rgba(0, 0, 0, 0.7)",

      backgroundImage: `linear-gradient(to bottom, #141E30, #243B55)`,
      animatedBackground: false,
            
      labels: {
        empUser: "Usuario",
        empPass: "ContraseÃ±a",
        conUser: "ID Contratista",
        conPass: "ContraseÃ±a"
      },
      
      successRedirect: "profile/profile.html",
      copyrightText: null,
      customCss: null
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITY FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const $ = (selector) => document.querySelector(selector);
    const $$ = (selector) => Array.from(document.querySelectorAll(selector));
    
    const setStyle = (prop, value) => {
      if (value) {
        document.documentElement.style.setProperty(prop, value);
      }
    };
    
    const detectTenant = () => {
      const host = location.hostname || 'localhost';

      if (host === 'localhost') {
    return 'demo';
  }
  if (host === '127.0.0.1') {
    return 'default';
  }
      const parts = host.split('.');
      
      if (parts.length > 2 && parts[0] !== 'www') {
        return parts[0];
      }
      
      return host === 'localhost' ? 'demo' : 'default';
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TENANT LOADING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const tenantId = detectTenant();
    
    async function loadTenantConfig() {
      try {
        const response = await fetch('./tenants/tenants.json', {
          cache: 'no-store',
          headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) throw new Error('Tenant config not found');
        
        const data = await response.json();
        const tenantConfig = data[tenantId] || data['default'] || {};
        
        // Deep merge with defaults
        const config = {
          ...DEFAULTS,
          ...tenantConfig,
          labels: { ...DEFAULTS.labels, ...(tenantConfig.labels || {}) }
        };
        
        return config;
      } catch (error) {
        console.warn('âš ï¸ Tenant config not loaded, using defaults:', error);
        return DEFAULTS;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // APPLY CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function applyConfiguration(config) {
      window.__appConfig = config;
      // 1. Aplicar las 10 variables "Maestras" al CSS
      setStyle('--bgPage', config.bgPage);
      setStyle('--textPage', config.textPage);
      
      setStyle('--primaryColor', config.primaryColor);
      setStyle('--secondaryColor', config.secondaryColor);
      
      setStyle('--bgBrand', config.bgBrand);
      setStyle('--textBrand', config.textBrand);
      
      setStyle('--bgForm', config.bgForm);
      setStyle('--textForm', config.textForm);
      
      setStyle('--bgSuccess', config.bgSuccess);
      setStyle('--bgError', config.bgError);
      setStyle('--bgOverlay', config.bgOverlay);

      // 2. Aplicar el "Interruptor" del Tema de Inputs
      document.body.dataset.inputTheme = config.inputTheme || 'dark';

      // 3. Aplicar el resto de la configuraciÃ³n (logo, textos, etc.)
      const logoIcon = $('#logoIcon');
      const logoText = $('#logoText');
      
    if (config.logoUrl) {
        logoIcon.innerHTML = `<img src="${config.logoUrl}" alt="Logo" style="max-width:100%; height: auto; object-fit:contain;" />`;
      } else {
        logoIcon.textContent = config.logoText;
      }
      
      logoText.textContent = config.companyName;

      $('#brandTitle').textContent = config.tagline;
      $('#brandDescription').textContent = config.description;

      const featuresContainer = $('#brandFeatures');
      if (featuresContainer && config.features && config.features.length > 0) {
        featuresContainer.innerHTML = config.features.map(feature => `
          <div class="feature-item">
            <svg class="feature-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
            </svg>
            <span>${feature}</span>
          </div>
        `).join('');
      } else if (featuresContainer) {
        featuresContainer.innerHTML = '';
      }

      $('#labelEmpUser').textContent = config.labels.empUser;
      $('#labelEmpPass').textContent = config.labels.empPass;
      $('#labelConUser').textContent = config.labels.conUser;
      $('#labelConPass').textContent = config.labels.conPass;

      $('#currentYear').textContent = new Date().getFullYear();

      if (config.backgroundImage) {
        $('.bg-animated').style.background = config.backgroundImage;
        $('.bg-animated').style.backgroundSize = 'cover';
        $('.bg-animated').style.backgroundPosition = 'center';
      }

      if (!config.animatedBackground) {
        $('.bg-orbs').style.display = 'none';
      }

      // 4. Aplicar CSS Personalizado (al final para que tenga mÃ¡s peso)
      if (config.customCss) {
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = config.customCss;
        document.head.appendChild(link);
      }

      window.__loginRedirect = config.successRedirect;

      initializeInteractions();
    }


function showModal(title, message, type = 'info', callback = null) {
  const modalRoot = $('#modalRoot');
  if (!modalRoot) return;

  const iconMap = {
    success: 'âœ“',
    error: 'âœ•',
    info: 'â„¹'
  };

  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-icon ${type}">${iconMap[type] || '!'}</div>
      <h3 class="modal-title">${title}</h3>
      <p class="modal-text">${message}</p>
      <div class="modal-actions">
        <button class="btn btn-primary" id="modalOk">Aceptar</button>
      </div>
    </div>
  `;

  modalRoot.innerHTML = '';
  modalRoot.appendChild(modal);

  const okBtn = modal.querySelector('#modalOk');
  okBtn.addEventListener('click', () => {
    modal.style.animation = 'fadeOut 200ms ease-out forwards';
    setTimeout(() => {
      modalRoot.innerHTML = '';
      if (callback) callback();
    }, 200);
  });
}
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TAB SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initializeInteractions() {
      const tabButtons = $$('.tab-btn');
      const forms = $$('.login-form');
      const capitalize = (str) => str.charAt(0).toUpperCase() + str.slice(1);

      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          const targetTab = button.dataset.tab;
          const targetFormId = `form${capitalize(targetTab)}`;
          
          if (button.classList.contains('active')) return;

          // Actualizar botones
          tabButtons.forEach(btn => {
            const isActive = btn.dataset.tab === targetTab;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-selected', isActive);
          });

          // Actualizar formularios con animaciÃ³n
          let formToLeave = null;
          forms.forEach(form => {
            if (form.classList.contains('active')) {
              formToLeave = form;
            }
            form.classList.remove('is-leaving'); 
          });


forms.forEach(form => {
        form.classList.remove('active');
      });

      // Mostrar solo el formulario objetivo
      const formToEnter = $(`#${targetFormId}`);
      if (formToEnter) {
        formToEnter.classList.add('active');
      }
        });
      });

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // FORM SUBMISSIONS
      // (El resto de la funciÃ³n sigue igual...)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
$('#formEmployees').addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = $('#empUsername').value.trim();
    const password = $('#empPassword').value.trim();

    console.log('1ï¸âƒ£ Iniciando login para:', username);
    
if (!username) {
      showModal('Error', 'Por favor, ingresa tu correo electrÃ³nico.', 'error');
      return;
    }
    
    const btn = $('#btnLoginEmp');
    btn.disabled = true;
    btn.querySelector('span').textContent = 'Ingresando...';

    let userMessage = 'Usuario o contraseÃ±a incorrecta.';

    try {
        // 1. INTENTO DE LOGIN ESTÃNDAR
        await supabase.from('registration_requests').insert({
          email: regEmail,
          name: regName,
          area: regArea,
          worker_id: idUser,
          tenant_id: window.__appConfig.tenantUUID
        });

        // 2. MANEJO DE FALLO DE LOGIN
if (authError || !authData.user) {
          console.log('2ï¸âƒ£ Login fallÃ³, verificando force_reset...');
            
            // ğŸ› CORRECCIÃ“N: Definimos data como profileCheck y error como checkError.
            const { data: profileCheck, error: checkError } = await supabase
                .from('profiles')
                .select('user_id, force_reset')
                .eq('email', username)
                .single();
            
            console.log('3ï¸âƒ£ profileCheck:', profileCheck);
            console.log('3ï¸âƒ£ checkError:', checkError); // <-- Ahora sÃ­ imprime undefined o el error.
            console.log('3ï¸âƒ£ force_reset value:', profileCheck?.force_reset);
            
            // Si el perfil existe Y tiene force_reset=true,
            if (profileCheck && profileCheck.force_reset) { 
              // Esto se ejecuta porque profileCheck.force_reset es true
              showResetPasswordModal({ id: profileCheck.user_id, email: username });
              
              btn.disabled = false;
              btn.querySelector('span').textContent = 'Ingresar';
              
              await supabase.auth.signOut(); 
              return; 
          } else {
                // El usuario no existe O no tiene reset forzado
                userMessage = 'Usuario o contraseÃ±a incorrecta.';
                throw new Error('Credenciales invÃ¡lidas');
            }
        }

        // 3. CONTINUACIÃ“N DEL FLUJO NORMAL (Login fue exitoso: authData.user es vÃ¡lido)
        
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('autorizado, tenant_id, force_reset')
          .eq('user_id', authData.user.id)
          .single();
        
        if (profileError) {
          userMessage = 'Error al cargar perfil de usuario.';
          throw new Error('Perfil no encontrado');
        }
        
        // 4. VERIFICACIÃ“N CRÃTICA DE FORCE_RESET (PRIORIDAD ABSOLUTA)
        if (profile.force_reset) {
            // Si es true, mostramos el modal de reseteo, ignorando 'autorizado' y 'tenant'.
            showResetPasswordModal(authData.user);
            
            btn.disabled = false;
            btn.querySelector('span').textContent = 'Ingresar';
            return;
        }

        // 5. OTRAS VERIFICACIONES (Si NO hay reset forzado)
        
        if (!profile.autorizado) {
            userMessage = 'Usuario no autorizado, contacte a su autorizador.';
            throw new Error('No autorizado');
        
        } else if (profile.tenant_id !== window.__appConfig.tenantUUID) {
            userMessage = 'Acceso no permitido en este portal.';
            throw new Error('Tenant incorrecto');

        } else {
            // 6. TODO BIEN -> ACCESO NORMAL
            showModal(
                'Â¡Bienvenido!',
                'Inicio de sesiÃ³n exitoso. Redirigiendo...',
                'success',
                () => { 
                    window.location.href = window.__loginRedirect || './profile/profile.html'; 
                }
            );
        }

    } catch (error) {
        // MANEJADOR DE ERROR FINAL
        await supabase.auth.signOut(); 
        
        btn.disabled = false;
        btn.querySelector('span').textContent = 'Ingresar';
        
        showModal('Error de Acceso', userMessage, 'error');
    }
});

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // REGISTRO BUTTON
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const registerBtn = $('#registerEmp');
      if (registerBtn) {
        registerBtn.addEventListener('click', (e) => {
          e.preventDefault();
          showRegistrationModal();
        });
      }
    };
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODAL SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showRegistrationModal() {
  const modalRoot = $('#modalRoot');
  if (!modalRoot) return;

  const config = window.__appConfig || DEFAULTS;
  const companyName = config.companyName || 'Tu CompaÃ±Ã­a';

  const modal = document.createElement('div');
  modal.className = 'modal-overlay';
  modal.innerHTML = `
    <div class="modal-content modal-form">
      <h3 class="modal-title">Solicitar Registro</h3>
      
      <div class="modal-body">
        <form id="registrationForm">
          <div class="form-group">
            <label class="form-label" for="regName">Nombre Completo</label>
            <input type="text" id="regName" class="form-input" required>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="regCompany">CompaÃ±Ã­a</label>
            <input type="text" id="regCompany" class="form-input" value="${companyName}" readonly>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="regArea">Ãrea o Departamento</label>
            <input type="text" id="regArea" class="form-input" required>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="regEmail">Correo ElectrÃ³nico</label>
            <input type="email" id="regEmail" class="form-input" required>
          </div>

          <div class="form-group">
            <label class="form-label" for="idUser">ID Usuario</label>
            <input type="text" id="idUser" class="form-input" required>
          </div>

          <div class="form-group">
            <label class="form-label" for="regPassword">Crear ContraseÃ±a</label>
            <input type="password" id="regPassword" class="form-input" required>
            <ul class="password-rules">
              <li id="rule-length">8+ Caracteres</li>
              <li id="rule-number">1 NÃºmero</li>
              <li id="rule-letter">1 Letra</li>
            </ul>
          </div>
          
          <div class="form-group">
            <label class="form-label" for="regConfirmPassword">Confirmar ContraseÃ±a</label>
            <input type="password" id="regConfirmPassword" class="form-input" required>
            <ul class="password-rules">
              <li id="rule-match">Las contraseÃ±as coinciden</li>
            </ul>
          </div>
        </form>
      </div>
      
      <div class="modal-actions">
        <button class="btn btn-secondary" id="modalCancel">Cancelar</button>
        <button class="btn btn-primary" id="modalSubmit">Enviar Solicitud</button>
      </div>
    </div>
  `;

  modalRoot.innerHTML = '';
  modalRoot.appendChild(modal);

  const closeModal = () => {
    modal.style.animation = 'fadeOut 200ms ease-out forwards';
    setTimeout(() => { modalRoot.innerHTML = ''; }, 200);
  };

  // --- ValidaciÃ³n de contraseÃ±a ---
  const passInput = modal.querySelector('#regPassword');
  const confirmInput = modal.querySelector('#regConfirmPassword');
  const rules = {
    length: modal.querySelector('#rule-length'),
    number: modal.querySelector('#rule-number'),
    letter: modal.querySelector('#rule-letter'),
    match: modal.querySelector('#rule-match')
  };

  const validatePassword = () => {
    const pass = passInput.value;
    const confirm = confirmInput.value;

    const isLength = pass.length >= 8;
    const hasNumber = /\d/.test(pass);
    const hasLetter = /[a-zA-Z]/.test(pass);
    const isMatch = pass === confirm && pass.length > 0;

    rules.length.classList.toggle('valid', isLength);
    rules.number.classList.toggle('valid', hasNumber);
    rules.letter.classList.toggle('valid', hasLetter);
    rules.match.classList.toggle('valid', isMatch);

    return isLength && hasNumber && hasLetter && isMatch;
  };

  passInput.addEventListener('input', validatePassword);
  confirmInput.addEventListener('input', validatePassword);

  // --- Botones ---
  const cancelBtn = modal.querySelector('#modalCancel');
  const submitBtn = modal.querySelector('#modalSubmit');

  cancelBtn.addEventListener('click', closeModal);

  submitBtn.addEventListener('click', async (e) => {
    e.preventDefault();

    const form = modal.querySelector('#registrationForm');
    if (!form.checkValidity()) {
      showModal('Error', 'Por favor completa todos los campos requeridos.', 'error');
      return;
    }

    if (!validatePassword()) {
      showModal('ContraseÃ±a InvÃ¡lida', 'Tu contraseÃ±a no cumple los requisitos.', 'error');
      return;
    }

    try {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Enviando...';

      const regName = modal.querySelector('#regName').value.trim();
      const regArea = modal.querySelector('#regArea').value.trim();
      const regEmail = modal.querySelector('#regEmail').value.trim();
      const idUser = modal.querySelector('#idUser').value.trim();

      // â¬‡ï¸ NUEVO MODELO: SOLO insertar registro temporal
      const { error: reqError } = await supabase
        .from('registration_requests')
        .insert({
          email: regEmail,
          nombre: regName,
          area_departamento: regArea,
          tenant_id: window.__appConfig.tenantUUID
        });

      if (reqError) throw reqError;

      closeModal();
      setTimeout(() => {
        showModal(
          'Solicitud enviada',
          'Tu solicitud serÃ¡ revisada por un administrador.',
          'success'
        );
      }, 300);

    } catch (error) {
      console.error(error);
      submitBtn.disabled = false;
      submitBtn.textContent = 'Enviar Solicitud';
      showModal('Error', 'OcurriÃ³ un error inesperado.', 'error');
    }
  });
}

function showResetPasswordModal(user) {
    console.log('ğŸ”µ showResetPasswordModal llamado con:', user); // ğŸ‘ˆ (A)
    const modalRoot = $('#modalRoot');
    console.log('ğŸ”µ modalRoot existe?', !!modalRoot); // ğŸ‘ˆ (B)
    if (!modalRoot) return

      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.innerHTML = `
        <div class="modal-content modal-form">
          <h3 class="modal-title">Cambio de ContraseÃ±a Requerido</h3>
          <p class="modal-text" style="text-align: left; margin-top: 1rem;">
            Por motivos de seguridad, debes establecer una nueva contraseÃ±a para continuar.
          </p>
          
          <div class="modal-body">
            <form id="resetPasswordForm">
              <div class="form-group">
                <label class="form-label" for="resetPassword">Nueva ContraseÃ±a</label>
                <input type="password" id="resetPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                <ul class="password-rules">
                  <li id="rule-length">8+ Caracteres</li>
                  <li id="rule-number">1 NÃºmero</li>
                  <li id="rule-letter">1 Letra</li>
                </ul>
              </div>
              
              <div class="form-group">
                <label class="form-label" for="resetConfirmPassword">Confirmar ContraseÃ±a</label>
                <input type="password" id="resetConfirmPassword" class="form-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required>
                <ul class="password-rules">
                   <li id="rule-match">Las contraseÃ±as coinciden</li>
                </ul>
              </div>
            </form>
          </div>
          
          <div class="modal-actions">
            <button class="btn btn-primary" id="modalSubmitReset">Guardar y Continuar</button>
          </div>
        </div>
      `;

      modalRoot.innerHTML = '';
      modalRoot.appendChild(modal);

      const passInput = $('#resetPassword');
      const confirmInput = $('#resetConfirmPassword');
      const rules = {
        length: $('#rule-length'),
        number: $('#rule-number'),
        letter: $('#rule-letter'),
        match: $('#rule-match')
      };
      
      const validatePassword = () => {
        const pass = passInput.value;
        const confirm = confirmInput.value;
        
        const isLength = pass.length >= 8;
        const hasNumber = /\d/.test(pass);
        const hasLetter = /[a-zA-Z]/.test(pass);
        const isMatch = pass.length > 0 && pass === confirm;
        
        rules.length.classList.toggle('valid', isLength);
        rules.number.classList.toggle('valid', hasNumber);
        rules.letter.classList.toggle('valid', hasLetter);
        rules.match.classList.toggle('valid', isMatch);
        
        return isLength && hasNumber && hasLetter && isMatch;
      };
      
      passInput.addEventListener('input', validatePassword);
      confirmInput.addEventListener('input', validatePassword);

$('#modalSubmitReset').addEventListener('click', async () => {
    const submitBtn = $('#modalSubmitReset');

    if (!validatePassword()) {
        showModal('ContraseÃ±a InvÃ¡lida', 'Por favor revisa que tu contraseÃ±a cumpla los requisitos.', 'error');
        return;
    }

    try {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Guardando...';

        // Llamar a la Edge Function (que ya estÃ¡ en Supabase)
        const response = await fetch(
            'https://hvwygpnuunuuylzondxt.supabase.co/functions/v1/reset-password-user',
            {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'apikey': 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh2d3lncG51dW51dXlsem9uZHh0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1NDUzMTEsImV4cCI6MjA3NjEyMTMxMX0.FxjCX9epT_6LgWGdzdPhRUTP2vn4CLdixRqpFMRZK70'
                },
                body: JSON.stringify({
                    userId: user.id,
                    newPassword: passInput.value
                })
            }
        );

        const result = await response.json();

        if (!result.success) {
            throw new Error(result.error || 'Error al actualizar');
        }

        modalRoot.innerHTML = '';
        setTimeout(() => {
            showModal('Ã‰xito', 'ContraseÃ±a actualizada. Inicia sesiÃ³n nuevamente.', 'success', () => {
                window.location.reload();
            });
        }, 250);

    } catch (error) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Guardar y Continuar';
        showModal('Error', error.message, 'error');
    }
});
    }
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INITIALIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init() {
    console.log(`ğŸš€ Initializing tenant: ${tenantId}`);
    
    // 1. Cargar y aplicar configuraciÃ³n (CSS, textos)
    const config = await loadTenantConfig();
    applyConfiguration(config);

    // 2. Verificar la existencia del Tenant en la BD y obtener su UUID
    try {
        const { data: tenantDB, error } = await supabase
        .from('tenants')
        .select('id') // Solo necesitamos el 'id' (UUID)
        .eq('name', tenantId) // Compara 'name' (ej. 'jnj')
        .single();

        if (error) {
            throw new Error(`Tenant '${tenantId}' no encontrado en la base de datos.`);
        }

        // Guarda el UUID en la configuraciÃ³n global para usarlo despuÃ©s en el login
        window.__appConfig.tenantUUID = tenantDB.id;
        
    } catch (error) {
        console.error(error);
        // Muestra un error si el tenant no existe en la BD
        showModal(
            'Error de ConfiguraciÃ³n', 
            `El tenant '${tenantId}' no estÃ¡ configurado correctamente en la base de datos. Contacta a soporte.`, 
            'error'
        );
        // Bloqueamos la ejecuciÃ³n si hay un error crÃ­tico de configuraciÃ³n.
        return; 
    }
    
    console.log('âœ… Application ready');
} 

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DISPARADOR DE CARGA (FUERA DE init())
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
} else {
    init();
}

})(); // â† ğŸ”¹ ESTA CIERRA la funciÃ³n autoejecutable principal
</script>
</body>
</html>