<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestiÃ³n de Usuarios</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./global.css">
    <link rel="stylesheet" href="./users.css?v=4">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./supabase-client.js"></script>
</head>
<body>

    <!-- Navbar -->
    <nav class="top-navbar">
        <div class="logo-section">
            <h2 id="companyName"><i class="fas fa-graduation-cap"></i> Cargando...</h2>
        </div>
        <div class="nav-actions">
            <a href="../profile/profile.html" class="btn btn-outline">
                <i class="fas fa-user-circle"></i> Volver al Perfil
            </a>
            <a href="../index.html" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </div>
    </nav>

    <div class="container">
        <div class="user-list-container">
            <header class="list-header">
                <!-- SOLICITUDES PENDIENTES -->
                <div class="pending-requests-container">
                    <h2><i class="fas fa-user-plus"></i> Solicitudes Pendientes</h2>
                    <div class="request-table-wrapper">
                        <div class="request-table">
                            <div class="request-row header">
                                <div>Nombre</div>
                                <div>Email</div>
                                <div>Tipo</div>
                                <div>Fecha</div>
                                <div class="text-center">Acciones</div>
                            </div>
                            <div id="request-list-body">
                                <div class="loading-row">
                                    <i class="fas fa-spinner fa-spin"></i> Cargando solicitudes...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- USUARIOS AUTORIZADOS -->
                <h1><i class="fas fa-users-cog"></i> GestiÃ³n de Usuarios</h1>
                <div class="filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por nombre, correo...">
                    </div>
                </div>
            </header>

            <div class="user-table-wrapper">
                <div class="user-table">
                    <div class="user-row header">
                        <div>Nombre</div>
                        <div>Email</div>
                        <div>Rol</div>
                        <div id="tenant-header-col">Tenant</div>
                        <div class="text-center">Estado</div>
                        <div class="text-center">Acciones</div>
                    </div>
                    <div id="user-list-body">
                        <div class="loading-row" id="loadingRow">
                            <i class="fas fa-spinner fa-spin"></i> Cargando usuarios...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal General -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon"></div>
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button class="btn btn-primary" id="modalClose" style="width: 100%;">Aceptar</button>
        </div>
    </div>

    <!-- Modal de EdiciÃ³n -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <h3>Editar Usuario</h3>
            <form id="editForm">
                <input type="hidden" id="editUserId">

                <div class="form-group">
                    <label for="editNombre">Nombre Completo</label>
                    <input type="text" id="editNombre" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="editRole">Rol</label>
                    <select id="editRole" class="form-control">
                        <option value="user">Usuario</option>
                        <option value="supervisor">Supervisor</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>

                <div class="form-group" id="tenant-select-wrapper" style="display: none;">
                    <label for="editTenantSelect">Tenant</label>
                    <select id="editTenantSelect" class="form-control"></select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" id="cancelEditBtn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveEditBtn">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

<script>
(async () => {
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VARIABLES GLOBALES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const supabase = window.supabase;
    let currentAdmin = null;
    let searchTerm = '';
    let allTenants = [];

    // Referencias del DOM
    const userListBody = document.getElementById('user-list-body');
    const loadingRow = document.getElementById('loadingRow');
    const searchInput = document.getElementById('searchInput');
    const tenantHeaderCol = document.getElementById('tenant-header-col');

    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');
    const editUserId = document.getElementById('editUserId');
    const editNombre = document.getElementById('editNombre');
    const editEmail = document.getElementById('editEmail');
    const editRole = document.getElementById('editRole');
    const tenantSelectWrapper = document.getElementById('tenant-select-wrapper');
    const editTenantSelect = document.getElementById('editTenantSelect');
    const cancelEditBtn = document.getElementById('cancelEditBtn');
    const saveEditBtn = document.getElementById('saveEditBtn');

    const modal = document.getElementById('modal');
    const modalIcon = document.getElementById('modalIcon');
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalClose = document.getElementById('modalClose');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNCIONES DE UTILIDAD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function showModal(title, message, type = 'success') {
        modalTitle.textContent = title;
        modalMessage.textContent = message;
        modalIcon.className = `modal-icon ${type}`;
        modalIcon.innerHTML = 
            type === 'success' ? '<i class="fas fa-check-circle"></i>' :
            type === 'error' ? '<i class="fas fa-exclamation-triangle"></i>' :
            '<i class="fas fa-info-circle"></i>';
        modal.classList.add('show');
    }

    function closeModal() {
        modal.classList.remove('show');
    }

    modalClose.addEventListener('click', closeModal);

    function showModalConfirm(title, message) {
        return new Promise((resolve) => {
            modalTitle.textContent = title;
            modalMessage.style.whiteSpace = 'pre-wrap';
            modalMessage.textContent = message;
            modalIcon.className = 'modal-icon info';
            modalIcon.innerHTML = '<i class="fas fa-question-circle"></i>';
            modalClose.style.display = 'none';

            const actionContainer = document.createElement('div');
            actionContainer.className = 'modal-actions-confirm';
            actionContainer.style.marginTop = '1rem';
            actionContainer.style.display = 'flex';
            actionContainer.style.justifyContent = 'space-around';
            actionContainer.style.gap = '1rem';

            const cancelBtn = document.createElement('button');
            cancelBtn.className = 'btn btn-outline';
            cancelBtn.textContent = 'Cancelar';
            cancelBtn.style.flex = '1';

            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'btn btn-primary';
            confirmBtn.textContent = 'Confirmar';
            confirmBtn.style.flex = '1';

            const cleanup = (result) => {
                modal.classList.remove('show');
                actionContainer.remove();
                modalClose.style.display = 'block';
                modalMessage.style.whiteSpace = 'normal';
                resolve(result);
            };

            cancelBtn.addEventListener('click', () => cleanup(false));
            confirmBtn.addEventListener('click', () => cleanup(true));

            modal.querySelector('.modal-content').appendChild(actionContainer);
            actionContainer.appendChild(cancelBtn);
            actionContainer.appendChild(confirmBtn);

            modal.classList.add('show');
        });
    }

    function debounce(func, delay) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), delay);
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURACIÃ“N DE TENANT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const setStyle = (prop, value) => {
        if (value) document.documentElement.style.setProperty(prop, value);
    };

    const detectTenant = () => {
        const host = location.hostname || 'localhost';
        if (host === 'localhost') return 'demo';
        if (host === '127.0.0.1') return 'default';
        const parts = host.split('.');
        if (parts.length > 2 && parts[0] !== 'www') return parts[0];
        return 'default';
    };

    async function loadTenantConfig() {
        const tenantId = detectTenant();
        try {
            const response = await fetch('../tenants/tenants.json', { cache: 'no-store' });
            if (!response.ok) throw new Error('No se pudo cargar tenants.json');
            const data = await response.json();
            const config = data[tenantId] || data['default'] || {};

            const { data: tenantDB, error } = await window.supabase
                .from('tenants')
                .select('id')
                .eq('slug', tenantId)
                .single();

            if (error) throw new Error(`Tenant '${tenantId}' no encontrado en BD.`);
            config.tenantUUID = tenantDB.id;
            config.tenantSlug = tenantId;

            return config;
        } catch (error) {
            console.warn('âš ï¸ Error al cargar configuraciÃ³n del tenant:', error);
            return {};
        }
    }

    function applyConfiguration(config) {
        setStyle('--primaryColor', config.primaryColor);
        setStyle('--secondaryColor', config.secondaryColor);
        const companyNameEl = document.getElementById('companyName');
        if (companyNameEl && config.companyName) {
            const icon = companyNameEl.querySelector('i');
            companyNameEl.innerHTML = '';
            if (icon) companyNameEl.appendChild(icon);
            companyNameEl.appendChild(document.createTextNode(` ${config.companyName}`));
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTENTICACIÃ“N Y PERMISOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
async function loadAdminProfile(config) {
        console.log("ğŸ‘®â€â™‚ï¸ [SECURITY] Verificando credenciales...");
        
        try {
            const { data: { user }, error: authError } = await window.supabase.auth.getUser();
            
            if (authError || !user) {
                console.error("âŒ [SECURITY] No hay usuario logueado.");
                window.location.href = '../index.html';
                return null;
            }

            console.log(`ğŸ‘¤ [SECURITY] Usuario detectado: ${user.email}`);

            const { data: profile, error: profileError } = await window.supabase
                .from('profiles')
                .select('role, tenant_id')
                .eq('id', user.id)
                .single();

            if (profileError) {
                console.error("âŒ [SECURITY] Error buscando perfil:", profileError);
                throw profileError;
            }

            console.log("ğŸ“‹ [SECURITY] Datos del Perfil:", profile);
            console.log("ğŸ¢ [SECURITY] Datos del Tenant (Sitio):", {
                uuid: config.tenantUUID,
                slug: config.tenantSlug
            });

            // 1. Verificar Rol
            const allowedRoles = ['master', 'admin', 'supervisor'];
            if (!allowedRoles.includes(profile.role)) {
                console.warn(`â›” [SECURITY] Rol '${profile.role}' no permitido.`);
                showModal('Acceso Denegado', `Tu rol (${profile.role}) no tiene permisos de administraciÃ³n.`, 'error');
                setTimeout(() => window.location.href = '../profile/profile.html', 3000);
                return null;
            }

            // 2. Verificar Tenant (AquÃ­ suele fallar en localhost)
            // Si eres Admin/Supervisor, TU tenant_id debe ser igual al tenant_id de la pÃ¡gina
            if ((profile.role === 'admin' || profile.role === 'supervisor')) {
                if (profile.tenant_id !== config.tenantUUID) {
                    console.warn(`â›” [SECURITY] CONFLICTO DE TENANT.`);
                    console.warn(`   Esperado (Sitio): ${config.tenantUUID}`);
                    console.warn(`   Recibido (User):  ${profile.tenant_id}`);
                    
                    showModal('Conflicto de Tenant', 
                        `EstÃ¡s intentando administrar el tenant '${config.tenantSlug}'\npero tu usuario pertenece a otro tenant.\n\n(Revisa la consola con F12 para ver los IDs)`, 
                        'error');
                    
                    // Comenta esta lÃ­nea si quieres depurar sin que te expulse tan rÃ¡pido
                    // setTimeout(() => window.location.href = '../index.html', 4000);
                    return null;
                }
            }

            console.log("âœ… [SECURITY] Acceso Autorizado.");
            return profile;

        } catch (error) {
            console.error('Error al cargar perfil de admin:', error.message);
            showModal('Error de Seguridad', 'No se pudo verificar tu perfil.', 'error');
            return null;
        }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GESTIÃ“N DE SOLICITUDES PENDIENTES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadPendingRequests(adminRole, adminTenantId, tenantSlug) {
        try {
            let query = window.supabase
                .from('pending_registrations')
                .select('*')
                .order('created_at', { ascending: true });

            // Admin/Supervisor solo ve su tenant
            if (adminRole === 'admin' || adminRole === 'supervisor') {
                query = query.eq('tenant_slug', tenantSlug);
            }

            const { data, error } = await query;
            if (error) throw error;

            renderPendingRequests(data);
        } catch (error) {
            console.error('Error cargando solicitudes:', error.message);
            document.getElementById('request-list-body').innerHTML =
                '<div class="loading-row">Error al cargar solicitudes.</div>';
        }
    }

    function renderPendingRequests(requests) {
        const body = document.getElementById('request-list-body');
        body.innerHTML = '';

        if (requests.length === 0) {
            body.innerHTML = '<div class="loading-row">No hay solicitudes pendientes.</div>';
            return;
        }

        requests.forEach(req => {
            const row = document.createElement('div');
            row.className = 'request-row';
            
            // --- INICIO DE LA MODIFICACIÃ“N ---
            // AÃ±adir atributos data-label para el diseÃ±o responsivo
            row.innerHTML = `
                <div data-label="Nombre">${req.full_name || 'Sin nombre'}</div>
                <div data-label="Email">${req.email}</div>
                <div data-label="Tipo">${req.user_type}</div>
                <div data-label="Fecha">${new Date(req.created_at).toLocaleDateString()}</div>
                <div data-label="Acciones" class="actions text-center">
                    <button class="btn btn-primary btn-approve" data-id="${req.id}" data-email="${req.email}">
                        <i class="fas fa-check"></i> Aprobar
                    </button>
                    <button class="btn btn-outline btn-reject" data-id="${req.id}">
                        <i class="fas fa-times"></i> Rechazar
                    </button>
                </div>
            `;
            body.appendChild(row);
        });
    }

    // Configurar suscripciÃ³n a cambios en pending_registrations
function startPollingUpdates(adminRole, adminTenantId, tenantSlug) {
    console.log('ğŸ“¡ Modo Firewall: Iniciando Polling (recarga cada 10s)...');
    
    // Guardamos el intervalo en window para poder limpiarlo si salimos
    window.pollingInterval = setInterval(async () => {
        // Solo recargamos si la pestaÃ±a estÃ¡ visible (ahorra recursos)
        if (document.visibilityState === 'visible') {
            console.log('ğŸ”„ Polling: Verificando nuevos registros...');
            // Llamamos a tu funciÃ³n existente de carga
            await loadPendingRequests(adminRole, adminTenantId, tenantSlug);
        }
    }, 10000); // 10000 ms = 10 segundos
}
async function handleApproveRequest(requestId, requestEmail) {
    try {
        const confirmed = await showModalConfirm(
            'Aprobar Solicitud',
            `Â¿EstÃ¡s seguro de aprobar el registro de ${requestEmail}?\n\nEsto crearÃ¡ su cuenta en el sistema.`
        );

        if (!confirmed) return;

        // Obtener sesiÃ³n para el token
        const { data: { session } } = await window.supabase.auth.getSession();
        
        if (!session) throw new Error('No hay sesiÃ³n activa');

        // Llamar a la Edge Function
        const response = await fetch(
            'https://hvwygpnuunuuylzondxt.supabase.co/functions/v1/approve-registration',
            {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${session.access_token}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pending_id: requestId,
                    assign_role: 'user'
                })
            }
        );

        const result = await response.json();
        if (!result.success) throw new Error(result.error);

        showModal('Solicitud Aprobada', `${requestEmail} ha sido autorizado.`, 'success');
        
        await loadPendingRequests(currentAdmin.role, currentAdmin.tenant_id, window.tenantConfig.tenantSlug);
        await loadUserList(currentAdmin.role, currentAdmin.tenant_id);

    } catch (error) {
        showModal('Error', `No se pudo aprobar: ${error.message}`, 'error');
    }
}

    async function handleRejectRequest(requestId) {
        try {
            const confirmed = await showModalConfirm(
                'Rechazar Solicitud',
                'Â¿EstÃ¡s seguro de rechazar esta solicitud?\n\nSe eliminarÃ¡ permanentemente.'
            );

            if (!confirmed) return;

            const { error } = await window.supabase
                .from('pending_registrations')
                .delete()
                .eq('id', requestId);

            if (error) throw error;

            showModal('Solicitud Rechazada', 'La solicitud ha sido eliminada.', 'info');
            await loadPendingRequests(currentAdmin.role, currentAdmin.tenant_id, window.tenantConfig.tenantSlug);

        } catch (error) {
            showModal('Error', error.message, 'error');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GESTIÃ“N DE USUARIOS AUTORIZADOS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadUserList(adminRole, adminTenantId) {
        try {
            let query = window.supabase
                .from('profiles')
                .select(`
                    id, full_name, email, role, status,
                    tenant_id,
                    tenants ( name )
                `)

            if (adminRole === 'admin' || adminRole === 'supervisor') {
                query = query.eq('tenant_id', adminTenantId);
                tenantHeaderCol.style.display = 'none';
            } else if (adminRole === 'master') {
                tenantHeaderCol.style.display = 'block';
            }

            if (searchTerm) {
                query = query.or(
                    `full_name.ilike.%${searchTerm}%,` +
                    `email.ilike.%${searchTerm}%`
                );
            }

            query = query.limit(100);

            const { data: profiles, error } = await query;
            if (error) throw error;

            console.log(`ğŸ“Š Cargados ${profiles.length} usuarios (Rol: ${adminRole})`);
            renderUserList(profiles, adminRole);

        } catch (error) {
            console.error('Error:', error.message);
            loadingRow.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error: ' + error.message;
            userListBody.innerHTML = '';
            userListBody.appendChild(loadingRow);
        }
    }

    function renderUserList(profiles, adminRole) {
        userListBody.innerHTML = '';
        if (profiles.length === 0) {
            userListBody.innerHTML = '<div class="loading-row">No se encontraron usuarios.</div>';
            return;
        }

        profiles.forEach(profile => {
            const tenantName = (profile.tenants && profile.tenants.name) ? profile.tenants.name : 'N/A';
            const isActive = profile.status === 'active';

            const row = document.createElement('div');
            row.className = 'user-row';
            row.innerHTML = `
                <div data-label="Nombre">
                    <strong>${profile.full_name || 'Sin Nombre'}</strong>
                </div>
                <div data-label="Email">${profile.email || 'Sin Email'}</div>
                <div data-label="Rol">${profile.role}</div>
                <div data-label="Tenant" class="tenant-col" style="display: ${adminRole === 'master' ? 'flex' : 'none'};">
                    ${tenantName}
                </div>
                <div data-label="Estado" class="text-center">
                    <label class="toggle-switch">
                        <input 
                            type="checkbox" 
                            class="toggle-status" 
                            data-user-id="${profile.id}" 
                            ${isActive ? 'checked' : ''}
                        >
                        <span class="slider"></span>
                    </label>
                </div>
                <div data-label="Acciones" class="text-center actions">
                    <button 
                        class="btn btn-outline btn-edit" 
                        title="Editar Usuario"
                        data-user-id="${profile.id}"
                        data-nombre="${profile.full_name || ''}"
                        data-email="${profile.email || ''}"
                        data-role="${profile.role}"
                        data-tenant-id="${profile.tenant_id || ''}"
                    >
                        <i class="fas fa-edit"></i>
                    </button>
                    <button 
                        class="btn btn-outline btn-reset-pass" 
                        title="Resetear ContraseÃ±a"
                        data-user-id="${profile.id}"
                        data-user-email="${profile.email || 'Sin Email'}"
                    >
                        <i class="fas fa-key"></i>
                    </button>
                </div>
            `;
            userListBody.appendChild(row);
        });
    }

    async function handleToggleStatus(userId, newStatus) {
        try {
            const status = newStatus ? 'active' : 'inactive';

            const { error } = await window.supabase
                .from('profiles')
                .update({ status: status })
                .eq('id', userId);

            if (error) throw error;

            console.log(`âœ… Usuario ${userId} actualizado a: ${status}`);
            await loadUserList(currentAdmin.role, currentAdmin.tenant_id);

        } catch (error) {
            console.error('Error:', error);
            showModal('Error', `No se pudo actualizar: ${error.message}`, 'error');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MODAL DE EDICIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function loadTenantsIntoSelect() {
        try {
            const { data, error } = await window.supabase
                .from('tenants')
                .select('id, name')
                .order('name');

            if (error) throw error;

            allTenants = data;
            editTenantSelect.innerHTML = '';

            allTenants.forEach(tenant => {
                const option = document.createElement('option');
                option.value = tenant.id;
                option.textContent = tenant.name;
                editTenantSelect.appendChild(option);
            });

        } catch (error) {
            console.error('Error al cargar tenants:', error.message);
        }
    }

    function openEditModal(button) {
        const data = button.dataset;

        editUserId.value = data.userId;
        editNombre.value = data.nombre;
        editEmail.value = data.email;
        editRole.value = data.role;

        if (currentAdmin.role === 'master') {
            tenantSelectWrapper.style.display = 'block';
            editTenantSelect.value = data.tenantId;
        } else {
            tenantSelectWrapper.style.display = 'none';
        }

        editModal.classList.add('show');
    }

    function closeEditModal() {
        editModal.classList.remove('show');
        editForm.reset();
    }

    async function handleEditFormSubmit(e) {
        e.preventDefault();
        saveEditBtn.disabled = true;
        saveEditBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

        try {
            const userId = editUserId.value;
            const updateData = {
                full_name: editNombre.value,
                email: editEmail.value,
                role: editRole.value
            };

            if (currentAdmin.role === 'master') {
                updateData.tenant_id = editTenantSelect.value;
            }

            const { error } = await window.supabase
                .from('profiles')
                .update(updateData)
                .eq('id', userId);

            if (error) throw error;

            closeEditModal();
            showModal('Ã‰xito', 'Usuario actualizado correctamente.', 'success');
            await loadUserList(currentAdmin.role, currentAdmin.tenant_id);

        } catch (error) {
            console.error('Error:', error.message);
            showModal('Error', `No se pudo actualizar: ${error.message}`, 'error');
        } finally {
            saveEditBtn.disabled = false;
            saveEditBtn.textContent = 'Guardar Cambios';
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LISTENERS DE UI
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function initUIListeners() {
        // BÃºsqueda con debounce
        const debouncedSearch = debounce(async (e) => {
            searchTerm = e.target.value.toLowerCase().trim();
            loadingRow.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
            userListBody.innerHTML = '';
            userListBody.appendChild(loadingRow);

            if (currentAdmin) {
                await loadUserList(currentAdmin.role, currentAdmin.tenant_id);
            }
        }, 400);

        searchInput.addEventListener('input', debouncedSearch);

        // Modal de ediciÃ³n
        cancelEditBtn.addEventListener('click', closeEditModal);
        editForm.addEventListener('submit', handleEditFormSubmit);

        // DelegaciÃ³n de eventos - Lista de usuarios
userListBody.addEventListener('click', async (e) => {
        const target = e.target.closest('button, input[type="checkbox"]');
        if (!target) return;

        // 1. EDITAR USUARIO
        if (target.classList.contains('btn-edit')) {
            e.preventDefault();
            openEditModal(target);

        // 2. RESETEAR CONTRASEÃ‘A (LÃ³gica Nueva)
} else if (target.classList.contains('btn-reset-pass')) {
            e.preventDefault();
            const userId = target.dataset.userId;
            const userEmail = target.dataset.userEmail;

            // A. ConfirmaciÃ³n actualizada
            const confirm = await showModalConfirm(
                'Forzar Cambio de ContraseÃ±a',
                `Â¿Deseas obligar al usuario ${userEmail} a cambiar su contraseÃ±a en el prÃ³ximo inicio de sesiÃ³n?\n\n(El usuario deberÃ¡ ingresar con su contraseÃ±a actual para realizar el cambio).`
            );

            if (!confirm) return;

            // B. UI Feedback
            const originalContent = target.innerHTML;
            target.disabled = true;
            target.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // C. Llamada a Edge Function
                const { data, error } = await window.supabase.functions.invoke('admin-reset-password', {
                    body: { userId: userId }
                });

                if (error) throw new Error(error.message || 'Error de conexiÃ³n');
                if (data && !data.success) throw new Error(data.error || 'Error en el servidor');

                // D. Mensaje de Ã©xito simple (Sin contraseÃ±a temporal)
                showModal(
                    'AcciÃ³n Completada', 
                    `Se ha activado el cambio forzoso para ${userEmail}.\n\nLa prÃ³xima vez que ingrese, el sistema le pedirÃ¡ definir una nueva clave.`, 
                    'success'
                );

            } catch (err) {
                console.error(err);
                showModal('Error', 'No se pudo actualizar el estado: ' + err.message, 'error');
            } finally {
                target.innerHTML = originalContent;
                target.disabled = false;
            }

        // 3. CAMBIAR ESTADO (ACTIVO/INACTIVO)
        } else if (target.classList.contains('toggle-status')) {
            const userId = target.dataset.userId;
            const newStatus = target.checked;
            // No usamos await aquÃ­ para que la UI sea rÃ¡pida ("Optimistic UI"), 
            // pero handleToggleStatus maneja el error si falla.
            handleToggleStatus(userId, newStatus);
        }
    });

        // DelegaciÃ³n de eventos - Solicitudes pendientes
        document.getElementById('request-list-body').addEventListener('click', async (e) => {
            const btn = e.target.closest('button');
            if (!btn) return;

            const requestId = btn.dataset.id;
            const requestEmail = btn.dataset.email;

            if (btn.classList.contains('btn-approve')) {
                await handleApproveRequest(requestId, requestEmail);
            } else if (btn.classList.contains('btn-reject')) {
                await handleRejectRequest(requestId);
            }
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INICIALIZACIÃ“N
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function mainInit() {
        // 1. Cargar config del Tenant
        window.tenantConfig = await loadTenantConfig();
        applyConfiguration(window.tenantConfig);
        console.log('âœ… Tenant listo');

        // 2. Verificar permisos del Admin
        currentAdmin = await loadAdminProfile(window.tenantConfig);
        if (!currentAdmin) return;
        console.log(`âœ… Admin verificado (Rol: ${currentAdmin.role})`);

        // 3. Cargar tenants si es master
        if (currentAdmin.role === 'master') {
            await loadTenantsIntoSelect();
            console.log('âœ… Tenants cargados en el modal');
            
        }
        if (currentAdmin.role !== 'master') {
            document.querySelector('.user-table').classList.add('simple-view');
        }

        // 4. Cargar solicitudes pendientes
        await loadPendingRequests(currentAdmin.role, currentAdmin.tenant_id, window.tenantConfig.tenantSlug);
        console.log('âœ… Solicitudes pendientes cargadas');

        // 4.5 Activar Realtime para solicitudes pendientes
        startPollingUpdates(currentAdmin.role, currentAdmin.tenant_id, window.tenantConfig.tenantSlug);

        // 5. Cargar lista de usuarios autorizados
        await loadUserList(currentAdmin.role, currentAdmin.tenant_id);
        console.log('âœ… Lista de usuarios cargada');

        // 6. Iniciar listeners de la UI
        initUIListeners();
        console.log('âœ… UI inicializada');
        document.body.style.opacity = 1;
    }

    // Disparador de carga
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', mainInit);
    } else {
        mainInit();
    }

})();
</script>
</body>
</html>