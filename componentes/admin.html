<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    
    <!-- Iconos Globales -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Estilos Globales (un nivel arriba) -->
    <link rel="stylesheet" href="./global.css">
    
    <!-- Estilos específicos para esta página de tarjetas -->
    <link rel="stylesheet" href="./admin.css">

    <!-- Supabase Client (si es necesario para el tenant) -->
    <script src="../lib/supabase.js"></script>
    <script src="./supabase-client.js"></script>
</head>
<body>

    <!-- Navbar (Reutilizada de admin.html) -->
    <nav class="top-navbar">
        <div class="logo-section">
            <h2 id="companyName"><i class="fas fa-shield-alt"></i> Panel de Admin</h2>
        </div>
        <div class="nav-actions">
            <!-- Puedes ajustar estos enlaces según necesites -->
            <a href="../profile/profile.html" class="btn btn-outline">
                <i class="fas fa-user-circle"></i> Volver al Perfil
            </a>
            <a href="../index.html" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </div>
    </nav>

    <!-- Contenedor Principal -->
    <div class="container">
        
        <header class="admin-header">
            <h1>Panel de Administración</h1>
            <p>Selecciona una sección para gestionar.</p>
        </header>
        
        <!-- Contenedor donde se inyectarán las tarjetas -->
        <div class="card-grid" id="card-container">
            <!-- Las tarjetas se generan dinámicamente con JS -->
        </div>

    </div> <!-- Fin de .container -->

<script>
    // =================================================================
    // 1. DATA DE TARJETAS
    // =================================================================
    const adminCards = [
        {
            title: "Gestión de Usuarios",
            description: "Administrar, editar y autorizar a los usuarios de la plataforma.",
            icon: "fas fa-users-cog",
            link: "./users.html?v=3.3"
        },
        {
            title: "Gestión de Cursos",
            description: "Crear, editar y asignar cursos a los usuarios y tenants.",
            icon: "fas fa-book-open",
            link: "./pages/admi_curses.html?v=5"
        }
    ];

    function renderCards() {
        const container = document.getElementById('card-container');
        if (!container) return;
        let html = '';
        adminCards.forEach(card => {
            html += `
            <a href="${card.link}" class="admin-card">
                <div class="card-icon"><i class="${card.icon}"></i></div>
                <div class="card-content"><h2>${card.title}</h2><p>${card.description}</p></div>
                <div class="card-footer"><span>Ir a gestionar</span><i class="fas fa-arrow-right"></i></div>
            </a>`;
        });
        container.innerHTML = html;
    }
    
    // =================================================================
    // 2. LÓGICA DE INICIO (CON SEGURIDAD)
    // =================================================================
    async function mainInit() {
        // A. Esperar dependencias
        if (!window.supabase?.auth || !window.APP_CONFIG) { 
            setTimeout(mainInit, 100); 
            return; 
        }

        try {
            // B. BLINDAJE DE SESIÓN (Igual que Profile.js)
            // ---------------------------------------------------------
            const supabase = window.supabase;
            let { data: { session } } = await supabase.auth.getSession();

            // Recuperación manual si falla en prod
            if (!session) {
                const tokenKey = Object.keys(localStorage).find(k => k.startsWith('sb-') && k.endsWith('-auth-token'));
                if (tokenKey) {
                    try {
                        const token = JSON.parse(localStorage.getItem(tokenKey));
                        const { data } = await supabase.auth.setSession({
                            access_token: token.access_token,
                            refresh_token: token.refresh_token
                        });
                        if (data.session) session = data.session;
                    } catch(e) {}
                }
            }

            if (!session) {
                window.location.href = '../index.html';
                return;
            }
            // ---------------------------------------------------------

            // C. VERIFICACIÓN DE ROL (Solo Admins)
            const user = session.user;
            const role = user.app_metadata?.role || 'authenticated';
            const allowedRoles = ['master', 'admin', 'supervisor'];

            if (!allowedRoles.includes(role)) {
                alert('Acceso denegado: No eres administrador.');
                window.location.href = '../profile/profile.html';
                return;
            }

            // D. APLICAR ESTILOS (Lógica de Tenant)
            const config = window.APP_CONFIG;
            const companyNameEl = document.getElementById('companyName');
            if (companyNameEl) {
                 companyNameEl.innerHTML = `<i class="fas fa-shield-alt"></i> ${config.companyName || 'Panel Admin'}`;
            }

            // E. RENDERIZAR
            renderCards();
            document.body.style.opacity = 1;

        } catch (e) {
            console.error('Error init:', e);
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', mainInit);
    } else {
        mainInit();
    }
</script>

</body>
</html>