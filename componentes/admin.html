<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios</title>
    <!-- Reutilizamos los estilos e iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Estilos específicos para esta página -->
    <link rel="stylesheet" href="./admin.css">
    <link rel="stylesheet" href="../profile/profile.css">


    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="./supabase-client.js"></script>
</head>
<body>

    <!-- Navbar (Reutilizada) -->
    <nav class="top-navbar">
        <div class="logo-section">
            <h2 id="companyName"><i class="fas fa-graduation-cap"></i> Cargando...</h2>
        </div>
        <div class="nav-actions">
            <!-- Enlace para volver al perfil -->
            <a href="./profile.html" class="btn btn-outline">
                <i class="fas fa-user-circle"></i> Volver al Perfil
            </a>
            <a href="../index.html" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </div>
    </nav>

    <div class="container">
        
        <!-- Contenedor principal de la lista -->
        <div class="user-list-container">
            <header class="list-header">
                <h1><i class="fas fa-users-cog"></i> Gestión de Usuarios</h1>
                <div class="filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar por nombre, correo o área...">
                    </div>
                </div>
            </header>

            <!-- Wrapper para scroll horizontal en móvil -->
            <div class="user-table-wrapper">
                <!-- Tabla de Usuarios (CSS Grid) -->
                <div class="user-table">
                    <!-- Cabecera de la tabla -->
                    <div class="user-row header">
                        <div>Nombre</div>
                        <div>Email</div>
                        <div>Área / Depto.</div>
                        <div id="tenant-header-col">Tenant</div> <!-- Oculto por defecto, visible para 'master' -->
                        <div class="text-center">Autorizado</div>
                        <div class="text-center">Acciones</div>
                    </div>

                    <!-- Contenedor de la lista de usuarios (se rellena con JS) -->
                    <div id="user-list-body">
                        <!-- Fila de carga -->
                        <div class="loading-row" id="loadingRow">
                            <i class="fas fa-spinner fa-spin"></i> Cargando usuarios...
                        </div>
                    </div>
                </div>
            </div> <!-- Fin de .user-table-wrapper -->
        </div>

    </div> <!-- Fin de .container -->

    <!-- Modal (Reutilizado) -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon"></div>
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button class="btn btn-primary" id="modalClose" style="width: 100%;">Aceptar</button>
        </div>
    </div>
<div class="modal" id="editModal">
        <div class="modal-content">
            <h3>Editar Usuario</h3>
            <form id="editForm">
                <input type="hidden" id="editUserId">

                <div class="form-group">
                    <label for="editNombre">Nombre Completo</label>
                    <input type="text" id="editNombre" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="editEmail">Email</label>
                    <input type="email" id="editEmail" class="form-control" required>
                </div>

                <div class="form-group">
                    <label for="editArea">Área / Departamento</label>
                    <input type="text" id="editArea" class="form-control">
                </div>

                <div class="form-group" id="tenant-select-wrapper" style="display: none;">
                    <label for="editTenantSelect">Tenant</label>
                    <select id="editTenantSelect" class="form-control">
                        </select>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" id="cancelEditBtn">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveEditBtn">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>

<script>
    (async () => {

        // --- Almacén de estado ---
        let currentAdmin = null;
        let searchTerm = ''; // Estado para la búsqueda
        let allTenants = []; // [NUEVO] Caché para tenants

        // --- Referencias del DOM ---
        const userListBody = document.getElementById('user-list-body');
        const loadingRow = document.getElementById('loadingRow');
        const searchInput = document.getElementById('searchInput');
        const tenantHeaderCol = document.getElementById('tenant-header-col');

        // [NUEVO] Referencias del Modal de Edición
        const editModal = document.getElementById('editModal');
        const editForm = document.getElementById('editForm');
        const editUserId = document.getElementById('editUserId');
        const editNombre = document.getElementById('editNombre');
        const editEmail = document.getElementById('editEmail');
        const editArea = document.getElementById('editArea');
        const tenantSelectWrapper = document.getElementById('tenant-select-wrapper');
        const editTenantSelect = document.getElementById('editTenantSelect');
        const cancelEditBtn = document.getElementById('cancelEditBtn');
        const saveEditBtn = document.getElementById('saveEditBtn'); // Referencia para deshabilitar

        // --- Lógica del Tenant (Reutilizada) ---
        // (Tu código de setStyle, detectTenant, loadTenantConfig, applyConfiguration)
        // ... (sin cambios) ...
        const setStyle = (prop, value) => {
            if (value) document.documentElement.style.setProperty(prop, value);
        };

        const detectTenant = () => {
            const host = location.hostname || 'localhost';
            if (host === 'localhost') return 'demo';
            if (host === '127.0.0.1') return 'default';
            const parts = host.split('.');
            if (parts.length > 2 && parts[0] !== 'www') return parts[0];
            return 'default';
        };

        async function loadTenantConfig() {
            const tenantId = detectTenant();
            try {
                const response = await fetch('../tenants/tenants.json', { cache: 'no-store' });
                if (!response.ok) throw new Error('No se pudo cargar tenants.json');
                const data = await response.json();
                const config = data[tenantId] || data['default'] || {};
                
                const { data: tenantDB, error } = await supabase
                    .from('tenants')
                    .select('id')
                    .eq('name', tenantId)
                    .single();
                
                if (error) throw new Error(`Tenant '${tenantId}' no encontrado en BD.`);
                config.tenantUUID = tenantDB.id;
                
                return config;
            } catch (error) {
                console.warn('⚠️ Error al cargar configuración del tenant:', error);
                return {};
            }
        }

        function applyConfiguration(config) {
            setStyle('--primaryColor', config.primaryColor);
            setStyle('--secondaryColor', config.secondaryColor);
            const companyNameEl = document.getElementById('companyName');
            if (companyNameEl && config.companyName) {
                const icon = companyNameEl.querySelector('i');
                companyNameEl.innerHTML = '';
                if (icon) companyNameEl.appendChild(icon);
                companyNameEl.appendChild(document.createTextNode(` ${config.companyName}`));
            }
        }


        // --- Lógica de Modales (Reutilizada) ---
        const modal = document.getElementById('modal');
        const modalIcon = document.getElementById('modalIcon');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const modalClose = document.getElementById('modalClose');

        function showModal(title, message, type = 'success') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalIcon.className = `modal-icon ${type}`;
            modalIcon.innerHTML = type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-info-circle"></i>';
            if (type === 'error') modalIcon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            modal.classList.add('show');
        }
        function closeModal() { modal.classList.remove('show'); }
        modalClose.addEventListener('click', closeModal);

        // --- Lógica de la Página de Administración ---

        async function loadAdminProfile(config) {
            // ... (sin cambios) ...
             try {
                const { data: { user }, error: authError } = await supabase.auth.getUser();
                if (authError || !user) {
                    window.location.href = '../index.html';
                    return null;
                }

                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('role, tenant_id')
                    .eq('user_id', user.id)
                    .single();

                if (profileError) throw profileError;

                if (profile.role !== 'admin' && profile.role !== 'master') {
                    showModal('Acceso Denegado', 'No tienes permisos para ver esta página.', 'error');
                    setTimeout(() => window.location.href = './profile.html', 2000);
                    return null;
                }
                
                if (profile.role === 'admin' && profile.tenant_id !== config.tenantUUID) {
                   showModal('Conflicto de Tenant', 'Tu perfil de admin no coincide con este tenant.', 'error');
                   setTimeout(() => window.location.href = '../index.html', 2000);
                   return null;
                }

                return profile;
            } catch (error) {
                console.error('Error al cargar perfil de admin:', error.message);
                showModal('Error de Seguridad', 'No se pudo verificar tu perfil. Redirigiendo.', 'error');
                setTimeout(() => window.location.href = '../index.html', 3000);
                return null;
            }
        }
        
        // [NUEVO] Carga los tenants en el <select> del modal de edición
        async function loadTenantsIntoSelect() {
            try {
                const { data, error } = await supabase
                    .from('tenants')
                    .select('id, name')
                    .order('name');
                
                if (error) throw error;
                
                allTenants = data; // Guarda en caché
                editTenantSelect.innerHTML = ''; // Limpia
                
                allTenants.forEach(tenant => {
                    const option = document.createElement('option');
                    option.value = tenant.id;
                    option.textContent = tenant.name;
                    editTenantSelect.appendChild(option);
                });

            } catch (error) {
                console.error('Error al cargar tenants:', error.message);
                tenantSelectWrapper.innerHTML = '<small>Error al cargar tenants.</small>';
            }
        }

        /**
         * Carga la lista de usuarios (MODIFICADA para búsqueda en servidor)
         */
        async function loadUserList(adminRole, adminTenantId) {
            try {
                let query = supabase
                    .from('profiles')
                    .select(`
                        user_id, nombre, email, area_departamento, role, autorizado,
                        tenant_id, 
                        tenants ( name )
                    `); // [MODIFICADO] Añadido 'tenant_id'

                // REGLA DE SEGURIDAD (master vs admin)
                if (adminRole === 'admin') {
                    query = query.eq('tenant_id', adminTenantId);
                    tenantHeaderCol.style.display = 'none';
                } else if (adminRole === 'master') {
                    tenantHeaderCol.style.display = 'block';
                }

                // [MODIFICADO] AÑADIR FILTRO DE BÚSQUEDA (SERVER-SIDE)
                if (searchTerm) {
                    // ... (sin cambios) ...
                    query = query.or(
                        `nombre.ilike.%${searchTerm}%,` +
                        `email.ilike.%${searchTerm}%,` +
                        `area_departamento.ilike.%${searchTerm}%`
                    );
                }

                // [MODIFICADO] AÑADIR LÍMITE (Paginación básica)
                // ... (sin cambios) ...
                query = query.limit(100);

                const { data: profiles, error } = await query;
                if (error) throw error;

                renderUserList(profiles, adminRole);

            } catch (error) {
                console.error('Error al cargar lista de usuarios:', error.message);
                loadingRow.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error al cargar usuarios.';
                userListBody.innerHTML = ''; // Limpia para mostrar solo el error
                userListBody.appendChild(loadingRow);
            }
        }

        /**
         * Dibuja la lista de usuarios en el DOM.
         */
function renderUserList(profiles, adminRole) {
            userListBody.innerHTML = ''; // Limpia la lista
            if (profiles.length === 0) {
                userListBody.innerHTML = '<div class="loading-row">No se encontraron usuarios.</div>';
                return;
            }

            profiles.forEach(profile => {
                const tenantName = (profile.tenants && profile.tenants.name) ? profile.tenants.name : 'N/A';
                
                const row = document.createElement('div');
                row.className = 'user-row';
                
                // [MODIFICADO] Cambiado el botón de reset
                row.innerHTML = `
                    <div data-label="Nombre">
                        <strong>${profile.nombre || 'Sin Nombre'}</strong>
                        <small>${profile.role}</small>
                    </div>
                    <div data-label="Email">${profile.email || 'Sin Email'}</div>
                    <div data-label="Área">${profile.area_departamento || 'N/A'}</div>
                    <div data-label="Tenant" class="tenant-col" style="display: ${adminRole === 'master' ? 'flex' : 'none'};">
                        ${tenantName}
                    </div>
                    
                    <div data-label="Autorizado" class="text-center">
                        <label class="toggle-switch">
                            <input 
                                type="checkbox" 
                                class="toggle-authorize" 
                                data-user-id="${profile.user_id}" 
                                ${profile.autorizado ? 'checked' : ''}
                            >
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div data-label="Acciones" class="text-center actions">
                        <button 
                            class="btn btn-outline btn-edit" 
                            title="Editar Usuario"
                            data-user-id="${profile.user_id}"
                            data-nombre="${profile.nombre || ''}"
                            data-email="${profile.email || ''}"
                            data-area="${profile.area_departamento || ''}"
                            data-tenant-id="${profile.tenant_id || ''}"
                        >
                            <i class="fas fa-edit"></i>
                        </button>
                        <button 
                            class="btn btn-outline btn-reset-pass" 
                            title="Forzar Reseteo de Contraseña"
                            data-user-id="${profile.user_id}"
                        >
                            <i class="fas fa-key"></i>
                        </button>
                    </div>
                `;
                userListBody.appendChild(row);
            });
        }
        
        // [NUEVO] Abre el modal de edición y lo puebla con datos
        function openEditModal(button) {
            const data = button.dataset;
            
            editUserId.value = data.userId;
            editNombre.value = data.nombre;
            editEmail.value = data.email;
            editArea.value = data.area;
            
            // Lógica de visibilidad del Tenant
            if (currentAdmin.role === 'master') {
                tenantSelectWrapper.style.display = 'block';
                editTenantSelect.value = data.tenantId;
            } else {
                tenantSelectWrapper.style.display = 'none';
            }
            
            editModal.classList.add('show');
        }

        // [NUEVO] Cierra el modal de edición
        function closeEditModal() {
            editModal.classList.remove('show');
            editForm.reset(); // Limpia el formulario
        }

        // [NUEVO] Maneja el envío del formulario de edición
        async function handleEditFormSubmit(e) {
            e.preventDefault();
            saveEditBtn.disabled = true;
            saveEditBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';

            try {
                const userId = editUserId.value;
                const updateData = {
                    nombre: editNombre.value,
                    email: editEmail.value,
                    area_departamento: editArea.value
                };

                // Solo el 'master' puede cambiar el tenant_id
                if (currentAdmin.role === 'master') {
                    updateData.tenant_id = editTenantSelect.value;
                }

                const { error } = await supabase
                    .from('profiles')
                    .update(updateData)
                    .eq('user_id', userId);

                if (error) throw error;

                closeEditModal();
                showModal('Éxito', 'Usuario actualizado correctamente.', 'success');
                // Recarga la lista para mostrar los cambios
                await loadUserList(currentAdmin.role, currentAdmin.tenant_id);

            } catch (error) {
                console.error('Error al actualizar usuario:', error.message);
                showModal('Error', `No se pudo actualizar: ${error.message}`, 'error');
            } finally {
                saveEditBtn.disabled = false;
                saveEditBtn.textContent = 'Guardar Cambios';
            }
        }


async function handleForceReset(userId) {
            if (!userId) {
                showModal('Error', 'No se pudo identificar al usuario.', 'error');
                return;
            }
            
            const userConfirmed = await showModalConfirm(
                'Forzar Reseteo y Bloquear', 
                '¿Estás seguro? Esto bloqueará el acceso del usuario y le forzará a cambiar su contraseña.'
            );
            
            if (!userConfirmed) {
                return;
            }
async function handleForceReset(userId) {
            if (!userId) {
                showModal('Error', 'No se pudo identificar al usuario.', 'error');
                return;
            }
            
            const userConfirmed = await showModalConfirm(
                'Forzar Reseteo', 
                '¿Estás seguro? El usuario deberá cambiar su contraseña la próxima vez que inicie sesión.'
            );
            
            if (!userConfirmed) {
                return;
            }

            try {
                // [CAMBIO CLAVE] Solo actualizamos 'force_reset'.
                // NO tocamos 'autorizado'.
                const { error } = await supabase
                    .from('profiles')
                    .update({ 
                        force_reset: true
                    })
                    .eq('user_id', userId);

                if (error) throw error;

                showModal('Éxito', 'El usuario deberá cambiar su contraseña en su próximo inicio de sesión.', 'success');
            
            } catch (error) {
                showModal('Error', `No se pudo forzar el reseteo: ${error.message}`, 'error');
            }
        }
        
        // [NUEVO] Helper para reemplazar confirm()
        function showModalConfirm(title, message) {
            // ... (sin cambios) ...
            return new Promise((resolve) => {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                modalIcon.className = 'modal-icon info';
                modalIcon.innerHTML = '<i class="fas fa-question-circle"></i>';
                
                // Clonar el botón para limpiar listeners
                const oldBtn = document.getElementById('modalClose');
                const newBtn = oldBtn.cloneNode(true);
                oldBtn.parentNode.replaceChild(newBtn, oldBtn);
                newBtn.id = 'modalClose';
                newBtn.textContent = 'Cancelar'; // Cambiamos texto
                
                // Crear botón de confirmación
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn btn-primary';
                confirmBtn.textContent = 'Aceptar';
                confirmBtn.style.width = '100%';
                confirmBtn.style.marginTop = '0.5rem';
                
                newBtn.parentNode.appendChild(confirmBtn);

                modal.classList.add('show');
                
                // Listeners
                confirmBtn.addEventListener('click', () => {
                    closeModalConfirm(confirmBtn, newBtn);
                    resolve(true);
                });
                
                newBtn.addEventListener('click', () => {
                    closeModalConfirm(confirmBtn, newBtn);
                    resolve(false);
                });
            });
        }
        
        // [NUEVO] Helper para cerrar el modal de confirmación
        function closeModalConfirm(confirmBtn, cancelBtn) {
            // ... (sin cambios) ...
            modal.classList.remove('show');
            confirmBtn.remove(); // Limpiamos el botón extra
            cancelBtn.textContent = 'Aceptar'; // Restauramos texto
            // Re-asignamos el listener original
            cancelBtn.addEventListener('click', closeModal);
        }

        async function handleToggleAuthorize(userId, newStatus) {
            // ... (sin cambios) ...
            try {
                const { error } = await supabase
                    .from('profiles')
                    .update({ autorizado: newStatus })
                    .eq('user_id', userId);
                
                if (error) throw error;
                console.log(`Usuario ${userId} actualizado a ${newStatus}`);
            } catch (error) {
                showModal('Error', `No se pudo actualizar el estado: ${error.message}`, 'error');
            }
        }
        
        // [NUEVO] Helper Debounce
function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        function initUIListeners() {
            
            // Listener para la barra de búsqueda (Server-Side)
            const debouncedSearch = debounce(async (e) => {
                searchTerm = e.target.value.toLowerCase().trim();
                
                // Mostramos 'loading' dentro del body de la tabla
                loadingRow.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Buscando...';
                userListBody.innerHTML = '';
                userListBody.appendChild(loadingRow);
                
                // Vuelve a cargar la lista desde Supabase con el filtro
                if(currentAdmin) {
                    await loadUserList(currentAdmin.role, currentAdmin.tenant_id);
                }
            }, 400); // Espera 400ms después de teclear

            searchInput.addEventListener('input', debouncedSearch);

            
            // Listeners para los botones (delegación de eventos)
            // (Este código ya lo tenías, ahora va aquí dentro)
            userListBody.addEventListener('click', (e) => {
                const toggle = e.target.closest('.toggle-authorize');
                const resetBtn = e.target.closest('.btn-reset-pass');
                const editBtn = e.target.closest('.btn-edit'); 

                if (toggle) {
                    const userId = toggle.dataset.userId;
                    const newStatus = toggle.checked;
                    handleToggleAuthorize(userId, newStatus);
                }

                if (resetBtn) {
                    // Cambiado de 'data-user-email' a 'data-user-id'
                    const userId = resetBtn.dataset.userId;
                    handleForceReset(userId); // Llama a la nueva función
                }

                if (editBtn) { 
                    openEditModal(editBtn);
                }
            });

            // [NUEVO] Listeners para el modal de edición
            cancelEditBtn.addEventListener('click', closeEditModal);
            editForm.addEventListener('submit', handleEditFormSubmit);
        
        }
        
userListBody.addEventListener('click', (e) => {
                const toggle = e.target.closest('.toggle-authorize');
                const resetBtn = e.target.closest('.btn-reset-pass');
                const editBtn = e.target.closest('.btn-edit'); 

                if (toggle) {
                    const userId = toggle.dataset.userId;
                    const newStatus = toggle.checked;
                    handleToggleAuthorize(userId, newStatus);
                }

                if (resetBtn) {
                    // Cambiado de 'data-user-email' a 'data-user-id'
                    const userId = resetBtn.dataset.userId;
                    handleForceReset(userId); // Llama a la nueva función
                }

                if (editBtn) { 
                    openEditModal(editBtn);
                }
            });

            // [NUEVO] Listeners para el modal de edición
            cancelEditBtn.addEventListener('click', closeEditModal);
            editForm.addEventListener('submit', handleEditFormSubmit);

        // --- Función Principal de Arranque ---
        async function mainInit() {
            // 1. Cargar config del Tenant (para colores y UUID)
            const config = await loadTenantConfig();
            applyConfiguration(config);
            console.log('✅ Tenant listo');

            // 2. Cargar perfil del Admin (para seguridad)
            currentAdmin = await loadAdminProfile(config);
            if (!currentAdmin) return;
            console.log(`✅ Admin verificado (Rol: ${currentAdmin.role})`);

            // [NUEVO] 3. Cargar tenants si es 'master'
            if (currentAdmin.role === 'master') {
                await loadTenantsIntoSelect();
                console.log('✅ Tenants cargados en el modal');
            }

            // 4. Cargar la lista de usuarios
            await loadUserList(currentAdmin.role, currentAdmin.tenant_id);
            console.log('✅ Lista de usuarios cargada');
            
            // 5. Iniciar listeners de la UI
            initUIListeners();
        }

        // --- Disparador de Carga ---
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', mainInit);
        } else {
            mainInit();
        }

    })();
    </script>
</body>
</html>