<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n</title>
    
    <!-- Iconos Globales -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Estilos Globales (un nivel arriba) -->
    <link rel="stylesheet" href="./global.css">
    
    <!-- Estilos espec√≠ficos para esta p√°gina de tarjetas -->
    <link rel="stylesheet" href="./admin.css">

    <!-- Supabase Client (si es necesario para el tenant) -->
    <script src="../lib/supabase.js"></script>
    <script src="./supabase-client.js"></script>
</head>
<body>

    <!-- Navbar (Reutilizada de admin.html) -->
    <nav class="top-navbar">
        <div class="logo-section">
            <h2 id="companyName"><i class="fas fa-shield-alt"></i> Panel de Admin</h2>
        </div>
        <div class="nav-actions">
            <!-- Puedes ajustar estos enlaces seg√∫n necesites -->
            <a href="../profile/profile.html" class="btn btn-outline">
                <i class="fas fa-user-circle"></i> Volver al Perfil
            </a>
            <a href="../index.html" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </div>
    </nav>

    <!-- Contenedor Principal -->
    <div class="container">
        
        <header class="admin-header">
            <h1>Panel de Administraci√≥n</h1>
            <p>Selecciona una secci√≥n para gestionar.</p>
        </header>
        
        <!-- Contenedor donde se inyectar√°n las tarjetas -->
        <div class="card-grid" id="card-container">
            <!-- Las tarjetas se generan din√°micamente con JS -->
        </div>

    </div> <!-- Fin de .container -->

<script>
        window.addEventListener('error', (e) => {
        console.error('üí• ERROR GLOBAL:', e.error);
    });
    
    console.log('üöÄ Script admin.html cargado');
    
    // =================================================================
    // 1. DATA DE TARJETAS
    // =================================================================
    const adminCards = [
        {
            title: "Gesti√≥n de Usuarios",
            description: "Administrar, editar y autorizar a los usuarios de la plataforma.",
            icon: "fas fa-users-cog",
            link: "./users.html?v=3.3"
        },
        {
            title: "Gesti√≥n de Cursos",
            description: "Crear, editar y asignar cursos a los usuarios y tenants.",
            icon: "fas fa-book-open",
            link: "./pages/admi_curses.html?v=5"
        }
    ];

    function renderCards() {
        console.log('üìã Renderizando tarjetas...');
        const container = document.getElementById('card-container');
        if (!container) {
            console.error('‚ùå No se encontr√≥ #card-container');
            return;
        }
        let html = '';
        adminCards.forEach(card => {
            html += `
            <a href="${card.link}" class="admin-card">
                <div class="card-icon"><i class="${card.icon}"></i></div>
                <div class="card-content"><h2>${card.title}</h2><p>${card.description}</p></div>
                <div class="card-footer"><span>Ir a gestionar</span><i class="fas fa-arrow-right"></i></div>
            </a>`;
        });
        container.innerHTML = html;
        console.log('‚úÖ Tarjetas renderizadas');
    }
    
    // =================================================================
    // 2. L√ìGICA DE INICIO (CON SEGURIDAD)
    // =================================================================
    async function mainInit() {
        console.log('‚è≥ Esperando dependencias...');
        console.log('   - Supabase:', !!window.supabase?.auth);
        console.log('   - APP_CONFIG:', !!window.APP_CONFIG);
        
        // A. Esperar dependencias
        if (!window.supabase?.auth || !window.APP_CONFIG) { 
            setTimeout(mainInit, 100); 
            return; 
        }

        console.log('‚úÖ Dependencias listas, iniciando...');

        try {
            const supabase = window.supabase;
            
            // B. BLINDAJE DE SESI√ìN
            console.log('üîê Verificando sesi√≥n...');
            let { data: { session } } = await supabase.auth.getSession();

            if (!session) {
                console.log('‚ö†Ô∏è Sin sesi√≥n, intentando recuperar...');
                const tokenKey = Object.keys(localStorage).find(k => k.startsWith('sb-') && k.endsWith('-auth-token'));
                if (tokenKey) {
                    try {
                        const token = JSON.parse(localStorage.getItem(tokenKey));
                        const { data } = await supabase.auth.setSession({
                            access_token: token.access_token,
                            refresh_token: token.refresh_token
                        });
                        if (data.session) session = data.session;
                    } catch(e) {
                        console.error('Error recuperando sesi√≥n:', e);
                    }
                }
            }

            if (!session) {
                console.error('‚ùå No hay sesi√≥n, redirigiendo a login');
                window.location.href = '../index.html';
                return;
            }

            console.log('‚úÖ Sesi√≥n activa:', session.user.email);

            // C. VERIFICACI√ìN DE ROL
            console.log('üë§ Consultando perfil...');
            const user = session.user;
            
            const { data: rawData, error } = await supabase
                .from('profiles')
                .select('*')
                .eq('id', user.id);

            console.log('üì¶ Respuesta de profiles:', { rawData, error });

            // FIX: Manejar Array o Objeto
            const profile = Array.isArray(rawData) ? rawData[0] : rawData;

            if (error || !profile) {
                console.error('‚ùå Error cargando perfil:', error);
                alert('Error al cargar tu perfil. Intenta iniciar sesi√≥n nuevamente.');
                window.location.href = '../index.html';
                return;
            }

            const role = String(profile.role || 'authenticated').toLowerCase().trim();
            const allowedRoles = ['master', 'admin', 'supervisor'];
            
            console.log('üé≠ DIAGN√ìSTICO DE ROL:');
            console.log('   - Rol crudo:', profile.role);
            console.log('   - Rol limpio:', role);
            console.log('   - Roles permitidos:', allowedRoles);
            console.log('   - ¬øIncluido?:', allowedRoles.includes(role));
            console.log('   - Profile completo:', profile);

            if (!allowedRoles.includes(role)) {
                console.error('‚õî ACCESO DENEGADO');
                console.error('   Tu rol:', role);
                console.error('   Roles v√°lidos:', allowedRoles);
                alert(`Acceso denegado.\nTu rol: "${role}"\nRoles permitidos: ${allowedRoles.join(', ')}`);
                window.location.href = '../profile/profile.html';
                return;
            }

            console.log('‚úÖ Acceso autorizado');

            // D. APLICAR ESTILOS
            const config = window.APP_CONFIG;
            const companyNameEl = document.getElementById('companyName');
            if (companyNameEl) {
                 companyNameEl.innerHTML = `<i class="fas fa-shield-alt"></i> ${config.companyName || 'Panel Admin'}`;
            }

            // E. RENDERIZAR
            renderCards();
            document.body.style.opacity = 1;
            console.log('üéâ Init completo');

        } catch (e) {
            console.error('üí• Error cr√≠tico en init:', e);
            alert('Error al cargar el panel. Revisa la consola.');
        }
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', mainInit);
    } else {
        mainInit();
    }
</script>

</body>
</html>