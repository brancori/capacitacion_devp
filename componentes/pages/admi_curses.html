<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administración de Cursos</title>
    
    <!-- 1. Estilos Globales -->
    <link rel="stylesheet" href="../../componentes/global.css">
    
    <!-- 2. Estilos Específicos -->
    <link rel="stylesheet" href="./admi_curses.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../supabase-client.js"></script>

</head>
<body>
    <!-- Header -->
    <nav class="top-navbar">
        <div class="logo-section">
            <h2 id="companyName"><i class="fas fa-graduation-cap"></i> TROX Academy</h2>
        </div>
        <div class="nav-actions">
            <a href="../profile/profile.html" class="btn btn-outline">
                <i class="fas fa-user"></i> Mi Perfil
            </a>
            <a href="../index.html" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </div>
    </nav>

<!-- Main Container -->
<div class="container">
    <!-- KPI Dashboard -->
    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-completed">--</div>
                <div class="kpi-label">Completado</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-spinner"></i></div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-active">--</div>
                <div class="kpi-label">En Progreso</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-expired">--</div>
                <div class="kpi-label">Vencidos</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-bolt"></i></div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-urgent">--</div>
                <div class="kpi-label">Urgentes</div>
            </div>
        </div>
    </div>

    <!-- Main View -->
    <div id="main-view">
        <!-- Controls -->
        <div class="controls">
            <div class="search-box">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" class="search-input" id="search-groups" placeholder="Buscar grupos...">
            </div>
            <button class="btn btn-primary" onclick="openNewGroupModal()">
                <span><i class="fas fa-plus"></i></span> Nuevo Grupo
            </button>
        </div>

        <!-- Groups Grid -->
        <div class="groups-grid" id="groups-container">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin empty-state-icon"></i>
                <p>Cargando grupos...</p>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detail-view" class="detail-view">
        <div class="detail-header">
            <button class="back-btn" onclick="backToMain()">
                <i class="fas fa-arrow-left"></i> Volver a Grupos
            </button>
            <h2 id="detail-group-name" style="margin-top: 1rem;"></h2>
            <div class="group-meta" id="detail-group-meta"></div>
        </div>
        
        <div class="detail-content-wrapper">
            <div class="tabs">
                <!-- Por defecto mostramos Usuarios primero, es más lógico al gestionar grupos -->
                <button class="tab active" onclick="switchTab('users')" data-tab="users"><i class="fas fa-users"></i> Miembros</button>
                <button class="tab" onclick="switchTab('courses')" data-tab="courses"><i class="fas fa-book"></i> Cursos Asignados</button>
            </div>

            <!-- Tab Miembros -->
            <div id="tab-users" class="tab-content">
                <div class="controls" style="box-shadow: none; padding: 0; margin-bottom: 1rem; background: transparent;">
                    <div class="search-box">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="text" class="search-input" id="search-member-input" placeholder="Buscar usuario por email para agregar...">
                    </div>
                    <button class="btn btn-primary" onclick="addMemberByEmail()">
                        <i class="fas fa-user-plus"></i> Agregar
                    </button>
                </div>
                <div id="users-list"></div>
            </div>

            <!-- Tab Cursos -->
            <div id="tab-courses" class="tab-content" style="display: none;">
                <div id="courses-list"></div>
                <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openAssignModal()">
                    ➕ Asignar Nuevos Cursos al Grupo
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Notifications Container -->
<div class="toast-container" id="toast-container"></div>

<!-- Modal Nuevo Grupo (Simple, usando prompt es feo, mejor un modal real reutilizado) -->
<!-- Reutilizamos el assign-modal structure pero cambiamos contenido dinámicamente o usamos prompt por ahora para no complicar el HTML -->

<!-- Assign Courses Modal -->
<div class="modal" id="assign-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Asignar Cursos</h3>
            <button class="modal-close" onclick="closeAssignModal()">✕</button>
        </div>
        <div class="modal-body">
            <div class="search-box" style="margin-bottom: 1rem;">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" class="search-input" id="search-catalog" placeholder="Buscar en catálogo...">
            </div>

            <div class="two-column">
                <div>
                    <div class="column-title">CATÁLOGO DE CURSOS</div>
                    <div class="course-list" id="catalog-list"></div>
                </div>
                <div>
                    <div class="column-title">SELECCIONADOS (<span id="selected-count">0</span>)</div>
                    <div id="selected-list"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeAssignModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmAssignment()">Asignar Cursos →</button>
        </div>
    </div>
</div>

<script>
(async () => {
    // =================================================================
    // ESTADO GLOBAL
    // =================================================================
    let currentAdmin = null;
    let currentGroup = null;
    let currentTab = 'users';
    
    // Cachés de datos
    let allGroups = [];
    let groupMembers = [];
    let allCourses = []; 
    let selectedCoursesToAssign = [];

    // =================================================================
    // CONFIGURACIÓN TENANT & AUTH
    // =================================================================
    const setStyle = (prop, value) => value && document.documentElement.style.setProperty(prop, value);

    async function loadTenantConfig() {
        // Lógica simplificada de detección
        const host = location.hostname === 'localhost' ? 'demo' : location.hostname.split('.')[0];
        const tenantId = (host === '127' || host === 'www') ? 'default' : host;
        
        try {
            const resp = await fetch('../tenants/tenants.json');
            const data = await resp.json();
            const config = data[tenantId] || data['default'] || {};
            
            // Obtener UUID del tenant real desde Supabase
            const { data: tDb } = await window.supabase
                .from('tenants')
                .select('id')
                .eq('slug', tenantId)
                .single();
            
            config.tenantUUID = tDb ? tDb.id : null;
            return config;
        } catch (e) { console.error(e); return {}; }
    }

    async function checkAuth(config) {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) return window.location.href = '../index.html';

        const { data: profile } = await window.supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();
        
        if (!['master', 'admin', 'supervisor'].includes(profile.role)) {
            alert('Acceso denegado');
            window.location.href = '../index.html';
            return null;
        }
        return profile;
    }

    // =================================================================
    // LOGICA DE DATOS (REAL SUPABASE)
    // =================================================================

    // 1. Cargar Grupos
    async function fetchGroups() {
        const { data, error } = await window.supabase
            .from('course_groups')
            .select('*')
            .eq('tenant_id', currentAdmin.tenant_id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error fetching groups:', error);
            return [];
        }
        return data;
    }

    // 2. Cargar KPIs Globales
    async function updateKPIs() {
        // Consultar assignments globales del tenant
        const { data, error } = await window.supabase
            .from('user_course_assignments')
            .select('status, due_date')
            .eq('tenant_id', currentAdmin.tenant_id);

        if (error) return;

        let completed = 0, active = 0, expired = 0, urgent = 0;
        const now = new Date();

        data.forEach(a => {
            if (a.status === 'completed') completed++;
            else if (a.status === 'in_progress' || a.status === 'not_started') active++;

            if (a.due_date && new Date(a.due_date) < now && a.status !== 'completed') {
                expired++;
            }
        });

        // Calculamos porcentaje
        const total = data.length;
        const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

        document.getElementById('kpi-completed').textContent = `${percent}%`;
        document.getElementById('kpi-active').textContent = active;
        document.getElementById('kpi-expired').textContent = expired;
        // Urgente mockeado por ahora o basado en fecha cercana
        document.getElementById('kpi-urgent').textContent = expired; 
    }

    // 3. Renderizar Grid de Grupos
    async function renderGroups(filter = '') {
        const container = document.getElementById('groups-container');
        allGroups = await fetchGroups();

        const filtered = allGroups.filter(g => g.name.toLowerCase().includes(filter.toLowerCase()));

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-layer-group"></i></div>
                    <h3>No se encontraron grupos</h3>
                    <p>Crea uno nuevo para comenzar</p>
                </div>`;
            return;
        }

        // Para cada grupo, necesitamos saber cuántos miembros tiene
        // Hacemos un fetch rápido de counts
        const groupsHTML = await Promise.all(filtered.map(async (g) => {
            const { count } = await window.supabase
                .from('group_members')
                .select('*', { count: 'exact', head: true })
                .eq('group_id', g.id);
            
            return `
            <div class="group-card" onclick="window.viewGroupDetail('${g.id}')">
                <div class="group-header">
                    <div class="group-info">
                        <h3><i class="fas fa-folder"></i> ${g.name}</h3>
                        <div class="group-meta">
                            <span><i class="fas fa-users"></i> ${count || 0} miembros</span>
                        </div>
                    </div>
                </div>
                <div class="group-actions">
                    <button class="btn btn-secondary">Ver Detalle</button>
                </div>
            </div>
            `;
        }));

        container.innerHTML = groupsHTML.join('');
    }

    // 4. Ver Detalle de Grupo
    window.viewGroupDetail = async (groupId) => {
        currentGroup = allGroups.find(g => g.id === groupId);
        if (!currentGroup) return;

        document.getElementById('main-view').style.display = 'none';
        document.getElementById('detail-view').classList.add('active');
        document.getElementById('detail-group-name').textContent = currentGroup.name;
        
        // Reset tabs
        window.switchTab('users');
    };

    window.backToMain = () => {
        document.getElementById('detail-view').classList.remove('active');
        document.getElementById('main-view').style.display = 'block';
        currentGroup = null;
        renderGroups(); // Recargar por si hubo cambios
    };

    window.switchTab = (tabName) => {
        currentTab = tabName;
        // UI Tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

        document.getElementById('tab-users').style.display = 'none';
        document.getElementById('tab-courses').style.display = 'none';
        document.getElementById(`tab-${tabName}`).style.display = 'block';

        if (tabName === 'users') loadGroupMembers();
        if (tabName === 'courses') loadGroupCourses();
    };

    // 5. Cargar Miembros del Grupo
    async function loadGroupMembers() {
        const container = document.getElementById('users-list');
        container.innerHTML = '<div class="spinner"></div> Cargando...';

        const { data, error } = await window.supabase
            .from('group_members')
            .select(`
                id,
                profiles (id, full_name, email, role, status)
            `)
            .eq('group_id', currentGroup.id);

        if (error) {
            container.innerHTML = 'Error al cargar miembros';
            return;
        }

        groupMembers = data; // Guardar referencia

        if (data.length === 0) {
            container.innerHTML = '<div class="empty-state">No hay miembros en este grupo</div>';
            return;
        }

        container.innerHTML = data.map(item => {
            const p = item.profiles;
            return `
            <div class="course-detail-item" style="padding: 1rem;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h4 style="margin:0;">${p.full_name}</h4>
                        <small style="color:var(--text-secondary)">${p.email}</small>
                    </div>
                    <button class="btn btn-secondary" onclick="removeMember('${item.id}')" style="color:var(--danger)">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            `;
        }).join('');
    }

    // 6. Agregar Miembro
    window.addMemberByEmail = async () => {
        const email = document.getElementById('search-member-input').value.trim();
        if (!email) return;

        // Buscar usuario
        const { data: user } = await window.supabase
            .from('profiles')
            .select('id, tenant_id')
            .eq('email', email)
            .single();

        if (!user) return showToast('Error', 'Usuario no encontrado', 'error');
        if (user.tenant_id !== currentAdmin.tenant_id) return showToast('Error', 'Usuario de otro tenant', 'error');

        // Insertar
        const { error } = await window.supabase
            .from('group_members')
            .insert({ group_id: currentGroup.id, user_id: user.id });

        if (error) {
            if (error.code === '23505') showToast('Info', 'El usuario ya está en el grupo', 'warning');
            else showToast('Error', error.message, 'error');
        } else {
            showToast('Éxito', 'Usuario agregado', 'success');
            document.getElementById('search-member-input').value = '';
            loadGroupMembers();
        }
    };

    window.removeMember = async (recordId) => {
        if(!confirm('¿Quitar usuario del grupo?')) return;
        await window.supabase.from('group_members').delete().eq('id', recordId);
        loadGroupMembers();
    };

    // 7. Cargar Cursos Asignados (Simulado consultando assignments de los miembros)
    // NOTA: Como no tenemos una tabla "group_assignments" directa, consultamos
    // qué cursos tienen en común los miembros o mostramos historial.
    // Para simplificar, mostraremos NADA por ahora, ya que la asignación
    // crea registros individuales. 
    async function loadGroupCourses() {
        const container = document.getElementById('courses-list');
        container.innerHTML = `
            <div class="empty-state">
                <p>Las asignaciones se generan individualmente para cada usuario.</p>
                <p>Usa el botón de abajo para asignar masivamente.</p>
            </div>`;
    }

    // 8. Crear Nuevo Grupo
    window.openNewGroupModal = async () => {
        const name = prompt("Nombre del nuevo grupo:");
        if (!name) return;

        const { error } = await window.supabase
            .from('course_groups')
            .insert({ name: name, tenant_id: currentAdmin.tenant_id });

        if (error) showToast('Error', error.message, 'error');
        else {
            showToast('Éxito', 'Grupo creado', 'success');
            renderGroups();
        }
    };

    // 9. Asignar Cursos (Modal)
    window.openAssignModal = async () => {
        if (!currentGroup) return;
        document.getElementById('assign-modal').classList.add('active');
        
        // Cargar catálogo de cursos reales
        const { data } = await window.supabase
            .from('articles') // Tabla de cursos
            .select('id, title, duration_text')
            .eq('tenant_id', currentAdmin.tenant_id)
            .eq('status', 'published');
            
        allCourses = data || [];
        selectedCoursesToAssign = [];
        renderCatalog();
        updateSelectedList();
    };

    window.closeAssignModal = () => {
        document.getElementById('assign-modal').classList.remove('active');
    };

    function renderCatalog(filter = '') {
        const container = document.getElementById('catalog-list');
        const filtered = allCourses.filter(c => c.title.toLowerCase().includes(filter.toLowerCase()));
        
        container.innerHTML = filtered.map(c => `
            <div class="course-item" onclick="toggleSelectCourse('${c.id}')">
                <input type="checkbox" ${selectedCoursesToAssign.find(s=>s.id===c.id)?'checked':''} pointer-events:none;">
                <div class="course-details">
                    <div class="course-title">${c.title}</div>
                    <small>${c.duration_text || ''}</small>
                </div>
            </div>
        `).join('');
    }

    window.toggleSelectCourse = (id) => {
        const exists = selectedCoursesToAssign.find(s => s.id === id);
        if (exists) {
            selectedCoursesToAssign = selectedCoursesToAssign.filter(s => s.id !== id);
        } else {
            const course = allCourses.find(c => c.id === id);
            selectedCoursesToAssign.push(course);
        }
        renderCatalog(document.getElementById('search-catalog').value);
        updateSelectedList();
    };

    function updateSelectedList() {
        const container = document.getElementById('selected-list');
        document.getElementById('selected-count').textContent = selectedCoursesToAssign.length;
        container.innerHTML = selectedCoursesToAssign.map(c => `
            <div class="selected-course-item">
                <strong>${c.title}</strong>
            </div>
        `).join('');
    }

    // 10. Confirmar Asignación Masiva
    window.confirmAssignment = async () => {
        if (selectedCoursesToAssign.length === 0) return showToast('Alerta', 'Selecciona cursos', 'warning');
        if (!groupMembers || groupMembers.length === 0) {
            // Intentar recargar miembros si está vacío
             await loadGroupMembers();
             if (groupMembers.length === 0) return showToast('Alerta', 'El grupo no tiene miembros', 'warning');
        }

        const assignments = [];
        const now = new Date();
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30); // 30 días por defecto

        // Crear una asignación por cada (Usuario x Curso Seleccionado)
        groupMembers.forEach(member => {
            selectedCoursesToAssign.forEach(course => {
                assignments.push({
                    user_id: member.profiles.id,
                    course_id: course.id,
                    tenant_id: currentAdmin.tenant_id,
                    status: 'not_started',
                    progress: 0,
                    assigned_at: now.toISOString(),
                    due_date: dueDate.toISOString()
                });
            });
        });

        const { error } = await window.supabase
            .from('user_course_assignments')
            .insert(assignments);

        if (error) {
            console.error(error);
            showToast('Error', 'Hubo un problema al asignar', 'error');
        } else {
            showToast('Éxito', `Asignados ${selectedCoursesToAssign.length} cursos a ${groupMembers.length} usuarios`, 'success');
            closeAssignModal();
        }
    };

    // Toast Helper
    function showToast(title, msg, type) {
        const container = document.getElementById('toast-container');
        const div = document.createElement('div');
        div.className = `toast ${type}`; // Asegúrate de tener CSS para .success, .error
        div.innerHTML = `<strong>${title}</strong>: ${msg}`;
        container.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    // =================================================================
    // INIT
    // =================================================================
    async function init() {
        const config = await loadTenantConfig();
        setStyle('--primaryColor', config.primaryColor);
        setStyle('--secondaryColor', config.secondaryColor);
        
        currentAdmin = await checkAuth(config);
        if (!currentAdmin) return;
        
        console.log('✅ Admin autenticado');
        
        await updateKPIs();
        await renderGroups();

        // IMPORTANTE: Hacer visible el body
        document.body.style.opacity = 1;
    }

    // Event Listeners búsqueda
    document.getElementById('search-groups').addEventListener('input', (e) => renderGroups(e.target.value));
    document.getElementById('search-catalog').addEventListener('input', (e) => renderCatalog(e.target.value));

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

})();
</script>
</body>
</html>