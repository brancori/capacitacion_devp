<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n de Cursos</title>
    
    <!-- 1. Estilos Globales (Subimos un nivel) -->
    <link rel="stylesheet" href="../../componentes/global.css">
    
    <!-- 2. Estilos Espec√≠ficos (Mismo nivel) -->
    <link rel="stylesheet" href="./admi_curses.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase Client (Subimos un nivel) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../../componentes/supabase-client.js"></script>

</head>
<body>
    <!-- Header -->
    <nav class="top-navbar">
        <div class="logo-section">
            <h2 id="companyName"><i class="fas fa-graduation-cap"></i> TROX Academy</h2>
        </div>
        <div class="nav-actions">
            <a href="../../profile/profile.html" class="btn btn-outline">
                <i class="fas fa-user"></i> Mi Perfil
            </a>
            <a href="../../index.html" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </div>
    </nav>

<!-- Main Container -->
<div class="container">
    <!-- KPI Dashboard -->
    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-check-circle"></i></div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-completed">--</div>
                <div class="kpi-label">Completado</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-spinner"></i></div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-active">--</div>
                <div class="kpi-label">En Progreso</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-exclamation-triangle"></i></div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-expired">--</div>
                <div class="kpi-label">Vencidos</div>
            </div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon"><i class="fas fa-bolt"></i></div>
            <div class="kpi-content">
                <div class="kpi-value" id="kpi-urgent">--</div>
                <div class="kpi-label">Urgentes</div>
            </div>
        </div>
    </div>

    <!-- Main View -->
    <div id="main-view">
        <!-- Controls -->
        <div class="controls">
            <div class="search-box">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" class="search-input" id="search-groups" placeholder="Buscar grupos...">
            </div>
            <button class="btn btn-primary" onclick="openNewGroupModal()">
                <span><i class="fas fa-plus"></i></span> Nuevo Grupo
            </button>
        </div>

        <!-- Groups Grid -->
        <div class="groups-grid" id="groups-container">
            <div class="empty-state">
                <i class="fas fa-spinner fa-spin empty-state-icon"></i>
                <p>Cargando grupos...</p>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detail-view" class="detail-view">
        <div class="detail-header">
            <button class="back-btn" onclick="backToMain()">
                <i class="fas fa-arrow-left"></i> Volver a Grupos
            </button>
            <h2 id="detail-group-name" style="margin-top: 1rem;"></h2>
            <div class="group-meta" id="detail-group-meta"></div>
        </div>
        
        <div class="detail-content-wrapper">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('users')" data-tab="users"><i class="fas fa-users"></i> Miembros</button>
                <button class="tab" onclick="switchTab('courses')" data-tab="courses"><i class="fas fa-book"></i> Cursos Asignados</button>
            </div>

            <!-- Tab Miembros -->
        <div id="tab-users" class="tab-content">
            <div class="two-column">
                <div>
                    <div class="column-title">DISPONIBLES PARA AGREGAR</div>
                    <div class="search-box" style="margin-bottom: 0.5rem;">
                        <span class="search-icon"><i class="fas fa-search"></i></span>
                        <input type="text" class="search-input" id="search-available" placeholder="Filtrar disponibles...">
                    </div>
                    <div class="course-list" id="available-users-list"></div>
                </div>
                <div>
                    <div class="column-title">MIEMBROS DEL GRUPO (<span id="members-count">0</span>)</div>
                    <div id="users-list"></div>
                </div>
            </div>
        </div>

            <!-- Tab Cursos -->
            <div id="tab-courses" class="tab-content" style="display: none;">
                <div id="courses-list"></div>
                <button class="btn btn-primary" style="margin-top: 1rem;" onclick="openAssignModal()">
                    ‚ûï Asignar Nuevos Cursos al Grupo
                </button>
            </div>
        </div>
    </div>
</div>

<div class="toast-container" id="toast-container"></div>

<!-- Assign Courses Modal -->
<div class="modal" id="assign-modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modal-title">Asignar Cursos</h3>
            <button class="modal-close" onclick="closeAssignModal()">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="search-box" style="margin-bottom: 1rem;">
                <span class="search-icon"><i class="fas fa-search"></i></span>
                <input type="text" class="search-input" id="search-catalog" placeholder="Buscar en cat√°logo...">
            </div>

            <div class="two-column">
                <div>
                    <div class="column-title">CAT√ÅLOGO DE CURSOS</div>
                    <div class="course-list" id="catalog-list"></div>
                </div>
                <div>
                    <div class="column-title">SELECCIONADOS (<span id="selected-count">0</span>)</div>
                    <div id="selected-list"></div>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeAssignModal()">Cancelar</button>
            <button class="btn btn-primary" onclick="confirmAssignment()">Asignar Cursos ‚Üí</button>
        </div>
    </div>
</div>

<script>
(async () => {
    // =================================================================
    // ESTADO GLOBAL
    // =================================================================
    let currentAdmin = null;
    let currentGroup = null;
    let currentTab = 'users';
    let allGroups = [];
    let groupMembers = [];
    let allCourses = []; 
    let selectedCoursesToAssign = [];

    // =================================================================
    // CONFIGURACI√ìN TENANT & AUTH (CORREGIDA)
    // =================================================================
    const setStyle = (prop, value) => value && document.documentElement.style.setProperty(prop, value);

    async function loadTenantConfig() {
        const host = location.hostname === 'localhost' ? 'demo' : location.hostname.split('.')[0];
        const tenantId = (host === '127' || host === 'www') ? 'default' : host;
        let config = {};

        // 1. FIX: Ruta corregida ../../tenants/tenants.json
        try {
            const resp = await fetch('../../tenants/tenants.json');
            if (resp.ok) {
                const data = await resp.json();
                config = data[tenantId] || data['default'] || {};
            } else {
                console.warn(`‚ö†Ô∏è tenants.json no encontrado en ../../tenants/tenants.json (Status: ${resp.status})`);
            }
        } catch (e) { 
            console.warn('‚ö†Ô∏è Error cargando/parseando tenants.json:', e); 
        }

        // 2. Fallback a DB
        try {
            const { data: tDb } = await window.supabase
                .from('tenants')
                .select('id, name')
                .eq('slug', tenantId)
                .single();
            
            if (tDb) {
                config.tenantUUID = tDb.id;
                if (!config.companyName) config.companyName = tDb.name;
            }
        } catch (e) {
            console.error('‚ùå Error cr√≠tico obteniendo Tenant ID de DB:', e);
        }

        // 3. Fallback visual final
        if (!config.companyName) config.companyName = tenantId.toUpperCase();
        
        return config;
    }

    async function checkAuth(config) {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (!user) {
            window.location.href = '../../index.html'; // Subimos 2 niveles
            return null;
        }

        const { data: profile } = await window.supabase
            .from('profiles')
            .select('*')
            .eq('id', user.id)
            .single();
        
        if (!profile || !['master', 'admin', 'supervisor'].includes(profile.role)) {
            alert('Acceso denegado: Rol insuficiente');
            window.location.href = '../../index.html'; // Subimos 2 niveles
            return null;
        }
        return profile;
    }

    // =================================================================
    // LOGICA DE DATOS
    // =================================================================

    async function fetchGroups() {
        // FIX: Evitar error 400 si tenant_id es null
        if (!currentAdmin.tenant_id) {
            console.warn('‚õî Usuario sin tenant_id, saltando fetchGroups');
            return [];
        }

        const { data, error } = await window.supabase
            .from('course_groups')
            .select('*')
            .eq('tenant_id', currentAdmin.tenant_id)
            .order('created_at', { ascending: false });

        if (error) {
            console.error('Error fetching groups:', error);
            return [];
        }
        return data;
    }

    async function updateKPIs() {
        if (!currentAdmin.tenant_id) return;

        const { data, error } = await window.supabase
            .from('user_course_assignments')
            .select('status, due_date')
            .eq('tenant_id', currentAdmin.tenant_id);

        if (error) return;

        let completed = 0, active = 0, expired = 0;
        const now = new Date();

        data.forEach(a => {
            if (a.status === 'completed') completed++;
            else if (['in_progress', 'not_started'].includes(a.status)) active++;

            if (a.due_date && new Date(a.due_date) < now && a.status !== 'completed') {
                expired++;
            }
        });

        const total = data.length;
        const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

        document.getElementById('kpi-completed').textContent = `${percent}%`;
        document.getElementById('kpi-active').textContent = active;
        document.getElementById('kpi-expired').textContent = expired;
        document.getElementById('kpi-urgent').textContent = expired; 
    }

    async function renderGroups(filter = '') {
        const container = document.getElementById('groups-container');
        
        if (!currentAdmin.tenant_id) {
            container.innerHTML = `<div class="empty-state">
                <h3>‚ö†Ô∏è Configuraci√≥n Incompleta</h3>
                <p>Tu usuario no tiene un Tenant ID asignado en la base de datos.</p>
            </div>`;
            return;
        }

        allGroups = await fetchGroups();

        const filtered = allGroups.filter(g => g.name.toLowerCase().includes(filter.toLowerCase()));

        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon"><i class="fas fa-layer-group"></i></div>
                    <h3>No se encontraron grupos</h3>
                    <p>Crea uno nuevo para comenzar</p>
                </div>`;
            return;
        }

        const groupsHTML = await Promise.all(filtered.map(async (g) => {
            // Contar miembros
            const { count } = await window.supabase
                .from('group_members')
                .select('*', { count: 'exact', head: true })
                .eq('group_id', g.id);
            
            return `
            <div class="group-card" onclick="window.viewGroupDetail('${g.id}')">
                <div class="group-header">
                    <div class="group-info">
                        <h3><i class="fas fa-folder"></i> ${g.name}</h3>
                        <div class="group-meta">
                            <span><i class="fas fa-users"></i> ${count || 0} miembros</span>
                        </div>
                    </div>
                </div>
                <div class="group-actions">
                    <button class="btn btn-secondary">Ver Detalle</button>
                </div>
            </div>
            `;
        }));

        container.innerHTML = groupsHTML.join('');
    }

    window.viewGroupDetail = async (groupId) => {
        currentGroup = allGroups.find(g => g.id === groupId);
        if (!currentGroup) return;

        document.getElementById('main-view').style.display = 'none';
        document.getElementById('detail-view').classList.add('active');
        document.getElementById('detail-group-name').textContent = currentGroup.name;
        window.switchTab('users');
    };

    window.backToMain = () => {
        document.getElementById('detail-view').classList.remove('active');
        document.getElementById('main-view').style.display = 'block';
        currentGroup = null;
        renderGroups();
    };

    window.switchTab = (tabName) => {
        currentTab = tabName;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');

        document.getElementById('tab-users').style.display = 'none';
        document.getElementById('tab-courses').style.display = 'none';
        document.getElementById(`tab-${tabName}`).style.display = 'block';

        if (tabName === 'users') loadGroupMembers();
        if (tabName === 'courses') loadGroupCourses();
    };

async function loadGroupMembers() {
    const membersContainer = document.getElementById('users-list');
    const availableContainer = document.getElementById('available-users-list');
    
    membersContainer.innerHTML = '<div class="spinner"></div> Cargando...';
    availableContainer.innerHTML = '<div class="spinner"></div> Cargando...';

    // 1. Obtener miembros actuales del grupo
    const { data: members, error: membersError } = await window.supabase
        .from('group_members')
        .select('id, user_id, profiles (id, full_name, email)')
        .eq('group_id', currentGroup.id);

    if (membersError) {
        membersContainer.innerHTML = 'Error al cargar miembros';
        return;
    }
    
    groupMembers = members || [];
    const memberIds = groupMembers.map(m => m.user_id);

    // 2. Obtener todos los usuarios del tenant
    const { data: allUsers, error: usersError } = await window.supabase
        .from('profiles')
        .select('id, full_name, email')
        .eq('tenant_id', currentAdmin.tenant_id)
        .order('full_name');

    if (usersError) {
        availableContainer.innerHTML = 'Error al cargar usuarios';
        return;
    }

    // 3. Filtrar disponibles (no est√°n en el grupo)
    const availableUsers = (allUsers || []).filter(u => !memberIds.includes(u.id));

    // 4. Renderizar miembros
    document.getElementById('members-count').textContent = groupMembers.length;
    
    if (groupMembers.length === 0) {
        membersContainer.innerHTML = '<div style="padding:1rem;color:var(--text-secondary);">Sin miembros</div>';
    } else {
        membersContainer.innerHTML = groupMembers.map(item => {
            const p = item.profiles;
            return `
            <div class="course-item" style="justify-content:space-between;">
                <div class="course-details">
                    <div class="course-title">${p.full_name || 'Sin nombre'}</div>
                    <small>${p.email}</small>
                </div>
                <button class="btn btn-secondary" onclick="removeMember('${item.id}')" style="color:var(--danger);padding:0.3rem 0.6rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>`;
        }).join('');
    }

    // 5. Renderizar disponibles
    window.allAvailableUsers = availableUsers;
    renderAvailableUsers('');
}

function renderAvailableUsers(filter) {
    const container = document.getElementById('available-users-list');
    const filtered = window.allAvailableUsers.filter(u => 
        u.full_name?.toLowerCase().includes(filter.toLowerCase()) ||
        u.email?.toLowerCase().includes(filter.toLowerCase())
    );

    if (filtered.length === 0) {
        container.innerHTML = '<div style="padding:1rem;color:var(--text-secondary);">No hay usuarios disponibles</div>';
        return;
    }

    container.innerHTML = filtered.map(u => `
        <div class="course-item" onclick="addMemberById('${u.id}')" style="cursor:pointer;">
            <div class="course-details">
                <div class="course-title">${u.full_name || 'Sin nombre'}</div>
                <small>${u.email}</small>
            </div>
            <i class="fas fa-plus" style="color:var(--success);"></i>
        </div>
    `).join('');
}

window.addMemberByEmail = async () => {
    const email = document.getElementById('search-member-input').value.trim();
    if (!email) return showToast('Alerta', 'Ingresa un email', 'warning');

    console.log('üîç Buscando email:', email);

    const { data: user, error } = await window.supabase
        .from('profiles')
        .select('id, tenant_id')
        .eq('email', email)
        .maybeSingle();  // üëà Cambio aqu√≠

    console.log('üì¶ Resultado:', { user, error });

    if (error) {
        console.error('‚ùå Error:', error);
        return showToast('Error', error.message, 'error');
    }

    if (!user) return showToast('Error', 'Usuario no encontrado o no pertenece a tu organizaci√≥n', 'error');
    
    if (user.tenant_id !== currentAdmin.tenant_id) {
        return showToast('Error', 'Usuario de otro tenant', 'error');
    }

    const { error: insertError } = await window.supabase
        .from('group_members')
        .insert({ group_id: currentGroup.id, user_id: user.id });

    if (insertError) {
        if (insertError.code === '23505') showToast('Info', 'El usuario ya est√° en el grupo', 'warning');
        else showToast('Error', insertError.message, 'error');
    } else {
        showToast('√âxito', 'Usuario agregado', 'success');
        document.getElementById('search-member-input').value = '';
        loadGroupMembers();
    }
};

    window.removeMember = async (recordId) => {
        if(!confirm('¬øQuitar usuario del grupo?')) return;
        await window.supabase.from('group_members').delete().eq('id', recordId);
        loadGroupMembers();
    };

    window.addMemberById = async (userId) => {
    const { error } = await window.supabase
        .from('group_members')
        .insert({ group_id: currentGroup.id, user_id: userId });

    if (error) {
        if (error.code === '23505') showToast('Info', 'El usuario ya est√° en el grupo', 'warning');
        else showToast('Error', error.message, 'error');
    } else {
        showToast('√âxito', 'Usuario agregado', 'success');
        loadGroupMembers();
    }
};

    async function loadGroupCourses() {
        const container = document.getElementById('courses-list');
        container.innerHTML = `
            <div class="empty-state">
                <p>Las asignaciones se generan individualmente para cada usuario.</p>
                <p>Usa el bot√≥n de abajo para asignar masivamente.</p>
            </div>`;
    }

    window.openNewGroupModal = async () => {
        if (!currentAdmin.tenant_id) return showToast('Error', 'No tienes tenant asignado', 'error');
        const name = prompt("Nombre del nuevo grupo:");
        if (!name) return;

        const { error } = await window.supabase
            .from('course_groups')
            .insert({ name: name, tenant_id: currentAdmin.tenant_id });

        if (error) showToast('Error', error.message, 'error');
        else {
            showToast('√âxito', 'Grupo creado', 'success');
            renderGroups();
        }
    };

    window.openAssignModal = async () => {
        if (!currentGroup) return;
        document.getElementById('assign-modal').classList.add('active');
        
        const { data } = await window.supabase
            .from('articles')
            .select('id, title, duration_text')
            .eq('tenant_id', currentAdmin.tenant_id)
            .eq('status', 'published');
            
        allCourses = data || [];
        selectedCoursesToAssign = [];
        renderCatalog();
        updateSelectedList();
    };

    window.closeAssignModal = () => {
        document.getElementById('assign-modal').classList.remove('active');
    };

    function renderCatalog(filter = '') {
        const container = document.getElementById('catalog-list');
        const filtered = allCourses.filter(c => c.title.toLowerCase().includes(filter.toLowerCase()));
        
        container.innerHTML = filtered.map(c => `
            <div class="course-item" onclick="toggleSelectCourse('${c.id}')">
                <input type="checkbox" ${selectedCoursesToAssign.find(s=>s.id===c.id)?'checked':''} pointer-events:none;">
                <div class="course-details">
                    <div class="course-title">${c.title}</div>
                    <small>${c.duration_text || ''}</small>
                </div>
            </div>
        `).join('');
    }

    window.toggleSelectCourse = (id) => {
        const exists = selectedCoursesToAssign.find(s => s.id === id);
        if (exists) {
            selectedCoursesToAssign = selectedCoursesToAssign.filter(s => s.id !== id);
        } else {
            const course = allCourses.find(c => c.id === id);
            selectedCoursesToAssign.push(course);
        }
        renderCatalog(document.getElementById('search-catalog').value);
        updateSelectedList();
    };

    function updateSelectedList() {
        const container = document.getElementById('selected-list');
        document.getElementById('selected-count').textContent = selectedCoursesToAssign.length;
        container.innerHTML = selectedCoursesToAssign.map(c => `
            <div class="selected-course-item">
                <strong>${c.title}</strong>
            </div>
        `).join('');
    }

    window.confirmAssignment = async () => {
        if (selectedCoursesToAssign.length === 0) return showToast('Alerta', 'Selecciona cursos', 'warning');
        if (!groupMembers || groupMembers.length === 0) {
             await loadGroupMembers();
             if (groupMembers.length === 0) return showToast('Alerta', 'El grupo no tiene miembros', 'warning');
        }

        const assignments = [];
        const now = new Date();
        const dueDate = new Date();
        dueDate.setDate(dueDate.getDate() + 30);

        groupMembers.forEach(member => {
            selectedCoursesToAssign.forEach(course => {
                assignments.push({
                    user_id: member.profiles.id,
                    course_id: course.id,
                    tenant_id: currentAdmin.tenant_id,
                    status: 'not_started',
                    progress: 0,
                    assigned_at: now.toISOString(),
                    due_date: dueDate.toISOString()
                });
            });
        });

        const { error } = await window.supabase
            .from('user_course_assignments')
            .insert(assignments);

        if (error) {
            console.error(error);
            showToast('Error', 'Hubo un problema al asignar', 'error');
        } else {
            showToast('√âxito', `Asignados ${selectedCoursesToAssign.length} cursos a ${groupMembers.length} usuarios`, 'success');
            closeAssignModal();
        }
    };

    function showToast(title, msg, type) {
        const container = document.getElementById('toast-container');
        const div = document.createElement('div');
        div.className = `toast ${type}`;
        div.innerHTML = `<strong>${title}</strong>: ${msg}`;
        container.appendChild(div);
        setTimeout(() => div.remove(), 3000);
    }

    // =================================================================
    // INIT
    // =================================================================
    async function init() {
        // 1. Cargar configuraci√≥n
        const config = await loadTenantConfig();
        if (config.primaryColor) setStyle('--primaryColor', config.primaryColor);
        if (config.secondaryColor) setStyle('--secondaryColor', config.secondaryColor);
        
        // 2. Chequear Auth
        currentAdmin = await checkAuth(config);
        if (!currentAdmin) return;

        // 3. FIX: "Patch" para Master sin tenant_id en perfil
        if (!currentAdmin.tenant_id && currentAdmin.role === 'master' && config.tenantUUID) {
            console.log('üîß Asignando Tenant ID del contexto al usuario Master');
            currentAdmin.tenant_id = config.tenantUUID;
        }
        
        console.log('‚úÖ Admin autenticado', currentAdmin);
        
        // 4. Cargar datos
        await updateKPIs();
        await renderGroups();

        document.body.style.opacity = 1;
    }

    document.getElementById('search-groups').addEventListener('input', (e) => renderGroups(e.target.value));
    document.getElementById('search-available')?.addEventListener('input', (e) => renderAvailableUsers(e.target.value));
    document.getElementById('search-catalog').addEventListener('input', (e) => renderCatalog(e.target.value));

    if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', init);
    else init();

})();
</script>
</body>
</html>