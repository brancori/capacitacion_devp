<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Perfil de CapacitaciÃ³n PRO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="./profile.css">
    <link rel="stylesheet" href="../componentes/global.css">
</head>
<body>

    <!-- Top Navigation -->
    <nav class="top-navbar">
        <div class="logo-section">
            <h2 id="companyName"><i class="fas fa-graduation-cap"></i> TROX Academy</h2>
        </div>
        <div class="nav-actions">

            <button class="notification-btn" id="notificationBtn">
                <i class="fas fa-bell"></i>
                <span class="notification-badge">3</span>
            </button>
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            <!-- CORRECCIÃ“N: Cambiado de <button> a <a> para el enlace -->
            <a href="../index.html" class="btn btn-outline">
                <i class="fas fa-sign-out-alt"></i> Salir
            </a>
        </div>
    </nav>

    <div class="container">
        <!-- 'stats-grid' se moviÃ³ dentro de 'content-area' -->

        <!-- Main Grid -->
        <div class="main-grid">
            <!-- Sidebar -->
            <div class="sidebar">
                <!-- Profile Card -->
                <div class="profile-card">
                    <div class="avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <h2 id="profileName">Cargando...</h2>
                    <p class="role">Contratista | ID: 789456</p>
                    
                    <div class="progress-donut">
                        <svg viewBox="0 0 150 150">
                            <circle class="progress-donut-bg" cx="75" cy="75" r="69"></circle>
                            <circle class="progress-donut-fg" cx="75" cy="75" r="69"></circle>
                        </svg>
                        <span class="progress-text">40%</span>
                    </div>
                    <p style="color: var(--primary); font-weight: 600; margin-bottom: 1rem;">
                        2 de 5 cursos completados
                    </p>
                    <button class="btn btn-primary" style="width: 100%;">
                        <i class="fas fa-user-edit"></i> Editar Perfil
                    </button>
                    <a href="../componentes/admin.html" class="btn btn-outline" id="manageUsersBtn" style="width: 100%; margin-top: 0.75rem; display: none;">
                        <i class="fas fa-users-cog"></i> AdminsitraciÃ³n<nav></nav>
                    </a>
                </div>

                <!-- Badges Card -->
                <div class="badges-card">
                    <h3><i class="fas fa-trophy"></i> Certificaciones</h3>
                    <div class="badges-grid">
                        <div class="badge earned" title="CertificaciÃ³n Obtenida">
                            <i class="fas fa-first-aid"></i>
                            <span>Brigadista P. Auxilios Leader</span>
                        </div>
                        <div class="badge" title="Requiere: Curso de Primeros Auxilios Avanzado">
                            <i class="fas fa-fire-extinguisher"></i>
                            <span>Combate Incendios Leader</span>
                        </div>
                        <div class="badge" title="Requiere: 3 cursos de calidad completados">
                            <i class="fas fa-certificate"></i>
                            <span>Quality Expert</span>
                        </div>
                        <div class="badge" title="Requiere: Curso de Trabajos en Altura BÃ¡sico">
                            <i class="fas fa-hard-hat"></i>
                            <span>Alturas Instructor</span>
                        </div>
                        <div class="badge" title="Requiere: Alturas BÃ¡sico + Intermedio + Rescate">
                            <i class="fas fa-mountain"></i>
                            <span>Espacios Confinados Instructor</span>
                        </div>
                        <div class="badge" title="Requiere: 10+ certificaciones profesionales">
                            <i class="fas fa-crown"></i>
                            <span>LÃ­der HSE</span>
                        </div>
                    </div>
                    <button class="btn btn-outline" id="viewBadgesBtn" style="width: 100%; margin-top: 1rem; font-size: 0.9rem;">
                        <i class="fas fa-info-circle"></i> Ver Requisitos
                    </button>
                </div>

                <!-- Calendar Card -->
                <div class="calendar-card">
                    <h3><i class="far fa-calendar-alt"></i> PrÃ³ximos Vencimientos</h3>
                    <div class="calendar-event urgent">
                        <div class="event-date">
                            <div class="day">30</div>
                            <div class="month">OCT</div>
                        </div>
                        <div class="event-details">
                            <h4>InducciÃ³n de Seguridad</h4>
                            <p>Vence en 3 dÃ­as</p>
                        </div>
                    </div>
                    <div class="calendar-event">
                        <div class="event-date">
                            <div class="day">26</div>
                            <div class="month">NOV</div>
                        </div>
                        <div class="event-details">
                            <h4>Manejo de QuÃ­micos</h4>
                            <p>Vence en 30 dÃ­as</p>
                        </div>
                    </div>
                    <div class="calendar-event">
                        <div class="event-date">
                            <div class="day">26</div>
                            <div class="month">DIC</div>
                        </div>
                        <div class="event-details">
                            <h4>Uso de Extintores</h4>
                            <p>Vence en 60 dÃ­as</p>
                        </div>
                    </div>
                </div>
            </div> <!-- Cierre de .sidebar -->

            <!-- Main Content -->
            <div class="content-area">
                
                <!-- CORRECCIÃ“N: 'stats-grid' movido aquÃ­ dentro -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon total">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-content">
                            <h3>5</h3>
                            <p>Cursos Totales</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon completed">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h3>2</h3>
                            <p>Completados</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon pending">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="stat-content">
                            <h3>2</h3>
                            <p>En Progreso</p>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon urgent">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div class="stat-content">
                            <h3>1</h3>
                            <p>Urgente</p>
                        </div>
                    </div>
                </div>

                <!-- Filter Bar -->
                <div class="filter-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" placeholder="Buscar cursos...">
                    </div>
                    <div class="filter-group">
                        <button class="filter-btn active" data-filter="all">Todos</button>
                        <button class="filter-btn" data-filter="urgent">Urgente</button>
                        <button class="filter-btn" data-filter="pending">Pendiente</button>
                        <button class="filter-btn" data-filter="completed">Completado</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                <div class="tab active" data-tab="catalog">CatÃ¡logo</div>
                <div class="tab" data-tab="assigned">Asignados</div>
                <div class="tab" data-tab="completed">Completados</div>
                </div>

                <div class="tab-content active" id="catalog">
                    <input id="searchInput" placeholder="Buscar cursos..." />
                    <div class="course-grid" id="courseCardsContainer"></div>
                </div>

                <div class="tab-content" id="assigned">
                    <div class="course-grid" id="assignedCourses"></div>
                </div>

                <div class="tab-content" id="completed">
                    <div class="course-grid" id="completedCourses"></div>
                </div>


                <!-- Tab Content: Assigned Courses -->
                <div class="tab-content active" id="assigned">
                <div class="course-grid" id="courseCardsContainer">
                    <!-- Los cursos estÃ¡ticos de demo los puedes dejar o quitar -->
                </div>
                </div>

                <!-- Tab Content: Certificates -->
                <div class="tab-content" id="certificates">
                <div class="course-grid" id="courseCardsContainer"></div>
                </div>


                <!-- Tab Content: Timeline (Estaba fuera) -->
                <div class="tab-content" id="timeline">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-content">
                                <div class="timeline-date">15 de Octubre, 2025</div>
                                <h3 style="color: var(--success); margin-bottom: 0.5rem;">
                                    <i class="fas fa-check-circle"></i> Curso Completado
                                </h3>
                                <p><strong>PolÃ­tica de Seguridad TROX</strong></p>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    CalificaciÃ³n obtenida: 95/100 | Certificado emitido
                                </p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-content">
                                <div class="timeline-date">10 de Octubre, 2025</div>
                                <h3 style="color: var(--warning); margin-bottom: 0.5rem;">
                                    <i class="fas fa-play-circle"></i> Curso Iniciado
                                </h3>
                                <p><strong>InducciÃ³n de Seguridad (Contratistas)</strong></p>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    En progreso: 60% completado
                                </p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-content">
                                <div class="timeline-date">1 de Septiembre, 2025</div>
                                <h3 style="color: var(--success); margin-bottom: 0.5rem;">
                                    <i class="fas fa-check-circle"></i> Curso Completado
                                </h3>
                                <p><strong>COVID-19: Protocolo de Acceso</strong></p>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    CalificaciÃ³n obtenida: 100/100 | Certificado emitido
                                </p>
                            </div>
                        </div>

                        <div class="timeline-item">
                            <div class="timeline-content">
                                <div class="timeline-date">25 de Agosto, 2025</div>
                                <h3 style="color: var(--primary); margin-bottom: 0.5rem;">
                                    <i class="fas fa-user-plus"></i> Registro en Plataforma
                                </h3>
                                <p><strong>Bienvenido a TROX Academy</strong></p>
                                <p style="color: var(--text-secondary); font-size: 0.9rem;">
                                    Tu cuenta ha sido activada correctamente
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Content: Recommendations (Estaba fuera) -->
                <div class="tab-content" id="recommendations">
                    <h2 style="margin-bottom: 1rem; color: var(--primary);">
                        <i class="fas fa-magic"></i> Cursos Recomendados Para Ti
                    </h2>
                    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
                        Basado en tu perfil, historial y cursos completados
                    </p>
                    
                    <div class="recommendations-grid">
                        <!-- Recommendation 1 -->
                        <div class="recommendation-card">
                            <div class="rec-header">
                                <div class="rec-icon">
                                    <i class="fas fa-hard-hat"></i>
                                </div>
                                <div>
                                    <h3 style="margin-bottom: 0.25rem;">Seguridad en Alturas</h3>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary);">
                                        Nivel Intermedio
                                    </p>
                                </div>
                                <span class="match-score">92%</span>
                            </div>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                                ContinuaciÃ³n ideal despuÃ©s de completar InducciÃ³n de Seguridad
                            </p>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <span style="background: #e6f0ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                                    6 horas
                                </span>
                                <span style="background: #e6f0ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                                    CertificaciÃ³n
                                </span>
                            </div>
                            <button class="btn btn-success btn-enroll" data-course="Seguridad en Alturas" style="width: 100%;">
                                <i class="fas fa-plus-circle"></i> Inscribirme
                            </button>
                        </div>

                        <!-- Recommendation 2 -->
                        <div class="recommendation-card">
                            <div class="rec-header">
                                <div class="rec-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <div>
                                    <h3 style="margin-bottom: 0.25rem;">EPP Avanzado</h3>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary);">
                                        Nivel Avanzado
                                    </p>
                                </div>
                                <span class="match-score">88%</span>
                            </div>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                                EspecializaciÃ³ncomplementaria a tus cursos actuales
                            </p>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <span style="background: #e6f0ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                                    4 horas
                                </span>
                                <span style="background: #e6f0ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                                    PrÃ¡ctico
                                </span>
                            </div>
                            <button class="btn btn-success btn-enroll" data-course="EPP Avanzado" style="width: 100%;">
                                <i class="fas fa-plus-circle"></i> Inscribirme
                            </button>
                        </div>

                        <!-- Recommendation 3 -->
                        <div class="recommendation-card">
                            <div class="rec-header">
                                <div class="rec-icon">
                                    <i class="fas fa-bolt"></i>
                                </div>
                                <div>
                                    <h3 style="margin-bottom: 0.25rem;">Riesgo ElÃ©ctrico</h3>
                                    <p style="font-size: 0.85rem; color: var(--text-secondary);">
                                        Nivel BÃ¡sico
                                    </p>
                                </div>
                                <span class="match-score">85%</span>
                            </div>
                            <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                                Muy solicitado en tu Ã¡rea de trabajo
                            </p>
                            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                                <span style="background: #e6f0ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                                    3 horas
                                </span>
                                <span style="background: #e6f0ff; color: var(--primary); padding: 0.25rem 0.75rem; border-radius: 15px; font-size: 0.8rem;">
                                    Popular
                                </span>
                            </div>
                            <button class="btn btn-success btn-enroll" data-course="Riesgo ElÃ©ctrico" style="width: 100%;">
                                <i class="fas fa-plus-circle"></i> Inscribirme
                            </button>
                        </div>
                    </div>
                </div>
            </div> <!-- Cierre de .content-area -->
        </div> <!-- Cierre de .main-grid -->
    </div> <!-- Cierre de .container -->

    <!-- Modal (Estaba fuera) -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-icon" id="modalIcon"></div>
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <button class="btn btn-primary" id="modalClose" style="width: 100%;">Aceptar</button>
        </div>
    </div>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../componentes/supabase-client.js"></script>
<script>
(function() {
        try {
          // 1. Obtener el slug actual SÃNCRONAMENTE
          const host = location.hostname || 'localhost';
          const parts = host.split('.');
          const currentSlug = parts.length > 2 && parts[0] !== 'www' ? parts[0] : 'default';

          // 2. Intentar cargar el tema cacheado
          const cachedTheme = localStorage.getItem('tenantTheme');
          const cachedSlug = localStorage.getItem('tenantSlug');

          // 3. Validar y aplicar el tema
          if (cachedTheme && cachedSlug === currentSlug) {
            const theme = JSON.parse(cachedTheme);
            const root = document.documentElement;
            
            // Aplicar estilos, asumiendo que el cachÃ© guarda primaryColor y secondaryColor
            if (theme.primaryColor) root.style.setProperty('--primaryColor', theme.primaryColor);
            if (theme.secondaryColor) root.style.setProperty('--secondaryColor', theme.secondaryColor);
            
            // Mostrar la pÃ¡gina inmediatamente ya que el tema es correcto
            document.body.style.opacity = 1;
          }
        } catch (e) {
          console.error('Error aplicando tema cacheado', e);
          // Si hay error, la pÃ¡gina se quedarÃ¡ oculta y la lÃ³gica principal la mostrarÃ¡
        }
      })();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BLOQUE ÃšNICO DE INICIALIZACIÃ“N
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async () => {

Â  // --- LÃ³gica del Tenant (Tu cÃ³digo original) ---
Â  const setStyle = (prop, value) => {
Â  Â  if (value) document.documentElement.style.setProperty(prop, value);
Â  };

Â  const detectTenant = () => {
Â  Â  const host = location.hostname || 'localhost';

Â  Â  if (host === 'localhost') {
Â  Â  Â  return 'demo';
Â  Â  }
Â  Â  if (host === '127.0.0.1') {
Â  Â  Â  return 'default';
Â  Â  }
Â  Â  const parts = host.split('.');
Â  Â  
Â  Â  if (parts.length > 2 && parts[0] !== 'www') {
Â  Â  Â  return parts[0];
Â  Â  }
Â  Â  
Â  Â  return 'default';
Â  };

Â  async function loadTenantConfig() {
Â  Â  const tenantId = detectTenant();
Â  Â  console.log(`ğŸ” Detectando tenant: ${tenantId}`);
Â  Â  try {
Â  Â  Â  const response = await fetch('../tenants/tenants.json', {
Â  Â  Â  Â  cache: 'no-store',
Â  Â  Â  Â  headers: { 'Accept': 'application/json' }
Â  Â  Â  });
Â  Â  Â  if (!response.ok) throw new Error('No se pudo cargar tenants.json');
Â  Â  Â  const data = await response.json();
Â  Â  Â  return data[tenantId] || data['default'] || {};
Â  Â  } catch (error) {
Â  Â  Â  console.warn('âš ï¸ Error al cargar configuraciÃ³n del tenant:', error);
Â  Â  Â  return {};
Â  Â  }
Â  }

function applyConfiguration(config) {
Â  Â  if (!config) return;
Â  Â  
Â  Â  // Colores
Â  Â  setStyle('--primaryColor', config.primaryColor);
Â  Â  setStyle('--secondaryColor', config.secondaryColor);

Â  Â  // Nombre de la compaÃ±Ã­a
Â  Â  const companyNameEl = document.getElementById('companyName');
Â  Â  if (companyNameEl && config.companyName) {
Â  Â  Â  const icon = companyNameEl.querySelector('i');
Â  Â  Â  companyNameEl.innerHTML = '';
Â  Â  Â  if (icon) companyNameEl.appendChild(icon);
Â  Â  Â  companyNameEl.appendChild(document.createTextNode(` ${config.companyName}`));
Â  Â  }
Â  Â  console.log(`ğŸ¨ Tenant aplicado: ${config.companyName || 'sin nombre definido'}`);

    // --- CAMBIO: Guardar la configuraciÃ³n en localStorage ---
    try {
        const tenantSlug = detectTenant();
        localStorage.setItem('tenantTheme', JSON.stringify(config));
        localStorage.setItem('tenantSlug', tenantSlug);
        console.log('ğŸ’¾ ConfiguraciÃ³n de tenant guardada en cachÃ©.');
    } catch (e) {
        console.warn('Advertencia: No se pudo guardar el tema en localStorage.', e);
    }
Â  }

Â  // --- LÃ³gica de Permisos (NUEVA) ---
Â  const manageUsersBtn = document.getElementById('manageUsersBtn');

Â  /**
Â  Â * Muestra u oculta elementos basados en el rol del usuario.
Â  Â */
Â  function updateProfileView(profile) {
Â  Â  // Actualizar el nombre
Â  Â  const profileNameEl = document.getElementById('profileName');
Â  Â  if (profileNameEl) {
      // *** CORREGIDO ***
Â  Â  Â  profileNameEl.textContent = profile.full_name || 'Usuario';
Â  Â  }

Â  Â  // LÃ³gica de permisos existente
    // *** CORREGIDO (para incluir 'supervisor') ***
    const allowedRoles = ['master', 'admin', 'supervisor'];
Â  Â  if (allowedRoles.includes(profile.role)) {
Â  Â  Â  if (manageUsersBtn) manageUsersBtn.style.display = 'flex';
Â  Â  } else {
Â  Â  Â  if (manageUsersBtn) manageUsersBtn.style.display = 'none';
Â  Â  }
Â  }
function getDueDateStatus(dueDate) {
  if (!dueDate) return { text: '', urgent: false };
  
  const ONE_DAY = 1000 * 60 * 60 * 24;
  const now = new Date();
  const due = new Date(dueDate);
  
  // Ignorar la hora, comparar solo fechas
  now.setHours(0, 0, 0, 0);
  due.setHours(0, 0, 0, 0);
  
  const diffTime = due.getTime() - now.getTime();
  const diffDays = Math.ceil(diffTime / ONE_DAY);

  if (diffDays < 0) return { text: 'Vencido', urgent: true };
  if (diffDays === 0) return { text: 'Vence hoy', urgent: true };
  if (diffDays === 1) return { text: 'Vence maÃ±ana', urgent: true };
  if (diffDays <= 7) return { text: `Vence en ${diffDays} dÃ­as`, urgent: true };
  
  return { text: `Vence en ${diffDays} dÃ­as`, urgent: false };
}
Â  /**
Â  Â * Carga el perfil del usuario desde Supabase y actualiza la vista.
Â  Â */
async function loadUserProfile() {
  try {
    // âœ… CAMBIO AQUÃ
    const { data: { user }, error: authError } = await window.supabase.auth.getUser();
    if (authError || !user) {
      console.error('No hay sesiÃ³n activa, redirigiendo al login.');
      window.location.href = '../index.html';
      return;
    }

    // âœ… CAMBIO AQUÃ
    const { data: profile, error: profileError } = await window.supabase
      .from('profiles')
      .select('role, full_name')
      .eq('id', user.id)
      .single();

    if (profileError) throw profileError;

    if (profile) {
      updateProfileView(profile);
    } else {
      console.warn('Usuario autenticado pero sin perfil.');
      updateProfileView({ role: 'user', full_name: 'Usuario' });
    }
  } catch (error) {
    console.error('Error al cargar el perfil del usuario:', error.message);
    updateProfileView({ role: 'user', full_name: 'Usuario' });
  }
}

Â  // --- LÃ³gica de UI (Modales, Tabs, Filtros) ---
Â  function initUI() {
    // ... (Todo tu cÃ³digo de UI original va aquÃ­, sin cambios) ...
Â  Â  // --- Modal general ---
Â  Â  const modal = document.getElementById('modal');
Â  Â  const modalIcon = document.getElementById('modalIcon');
Â  Â  const modalTitle = document.getElementById('modalTitle');
Â  Â  const modalMessage = document.getElementById('modalMessage');
Â  Â  const modalClose = document.getElementById('modalClose');

Â  Â  function showModal(title, message, type = 'success') {
Â  Â  Â  modalTitle.textContent = title;
Â  Â  Â  modalMessage.textContent = message;
Â  Â  Â  modalIcon.className = `modal-icon ${type}`;
Â  Â  Â  modalIcon.innerHTML = type === 'success'
Â  Â  Â  Â  ? '<i class="fas fa-check-circle"></i>'
Â  Â  Â  Â  : '<i class="fas fa-info-circle"></i>';
Â  Â  Â  modal.classList.add('show');
Â  Â  }
Â  Â  function closeModal() {
Â  Â  Â  modal.classList.remove('show');
Â  Â  }
Â  Â  modalClose.addEventListener('click', closeModal);
Â  Â  modal.addEventListener('click', (e) => {
Â  Â  Â  if (e.target === modal) closeModal();
Â  Â  });

Â  Â  // --- Tabs ---
Â  Â  const tabs = document.querySelectorAll('.tab');
Â  Â  const tabContents = document.querySelectorAll('.tab-content');
Â  Â  tabs.forEach(tab => {
Â  Â  Â  tab.addEventListener('click', () => {
Â  Â  Â  Â  tabs.forEach(t => t.classList.remove('active'));
Â  Â  Â  Â  tabContents.forEach(tc => tc.classList.remove('active'));
Â  Â  Â  Â  tab.classList.add('active');
Â  Â  Â  Â  document.getElementById(tab.dataset.tab).classList.add('active');
Â  Â  Â  });
Â  Â  });

Â  Â  // --- Filtros ---
Â  Â  const filterBtns = document.querySelectorAll('.filter-btn');
Â  Â  const courseCards = document.querySelectorAll('.course-card[data-status]');
Â  Â  filterBtns.forEach(btn => {
Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  filterBtns.forEach(b => b.classList.remove('active'));
Â  Â  Â  Â  btn.classList.add('active');
Â  Â  Â  Â  const filter = btn.dataset.filter;
Â  Â  Â  Â  courseCards.forEach(card => {
Â  Â  Â  Â  Â  card.style.display = (filter === 'all' || card.dataset.status === filter) ? 'flex' : 'none';
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  });

Â  Â  // --- Buscador ---
Â  Â  const searchInput = document.getElementById('searchInput');
Â  Â  searchInput.addEventListener('input', (e) => {
Â  Â  Â  const searchTerm = e.target.value.toLowerCase();
Â  Â  Â  document.querySelectorAll('.course-card').forEach(card => {
Â  Â  Â  Â  const title = card.querySelector('h3').textContent.toLowerCase();
Â  Â  Â  Â  card.style.display = title.includes(searchTerm) ? 'flex' : 'none';
      });;
Â  Â  });



Â  Â  // --- BotÃ³n de tema ---
Â  Â  const themeToggle = document.getElementById('themeToggle');
Â  Â  themeToggle?.addEventListener('click', () => {
Â  Â  Â  showModal('Cambio de Tema', 'El modo oscuro estarÃ¡ disponible prÃ³ximamente', 'info');
Â  Â  });

Â  Â  // --- AnimaciÃ³n de barras ---
Â  Â  const progressBars = document.querySelectorAll('.progress-bar-fill');
Â  Â  progressBars.forEach(bar => {
Â  Â  Â  const width = bar.style.width;
Â  Â  Â  bar.style.width = '0%';
Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  bar.style.width = width;
Â  Â  Â  }, 100);
Â  Â  });
Â  }

Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Â  // FUNCIÃ“N PRINCIPAL DE ARRANQUE
Â  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Â  async function mainInit() {
Â  Â  // 1. Carga la config del tenant
Â  Â  const config = await loadTenantConfig();
Â  Â  applyConfiguration(config);
Â  Â  console.log('âœ… Tenant listo');

Â  Â  document.body.style.opacity = 1;
Â  Â  // 2. Carga el perfil de usuario (para permisos)
Â  Â  await loadUserProfile();
Â  Â  console.log('âœ… Perfil de usuario cargado');

// ğŸ” Obtener usuario autenticado (LO QUE TE FALTABA)
const { data: authData, error: authError } = await window.supabase.auth.getUser();
if (authError || !authData?.user) {
  console.error("âŒ No hay sesiÃ³n activa", authError);
  return;
}
const userId = authData.user.id;

// Obtener profile (tenant + role)
const { data: profileRow, error: profileRowError } = await window.supabase
  .from("profiles")
  .select("tenant_id, role")
  .eq("id", userId)
  .single();

if (profileRowError) {
  console.error("âŒ Error al leer profileRow:", profileRowError);
  return;
}

const myTenant = profileRow?.tenant_id;
const myRole   = profileRow?.role;

console.log("ğŸ§­ Tenant usado en consulta:", myTenant, "Role:", myRole);
console.log("DEBUG authData:", authData);
console.log("DEBUG profileRow:", profileRow);
console.log("DEBUG myTenant, myRole:", myTenant, myRole);
// Query base
/*
let q = window.supabase
  .from("articles")
  .select("id, title, thumbnail_url, status, tenant_id");

if (myRole !== "master") {
  q = q.eq("tenant_id", myTenant);
}

const { data: courses, error: coursesError } = await q;
*/

const { data: assignments, error: coursesError } = await window.supabase
  .from("user_course_assignments")
  .select(`
    progress,
    due_date,
    articles (
      id,
      title,
      thumbnail_url,
      status,
      instructor_name,
      duration_text
    )
  `); // La RLS "Los usuarios pueden ver sus propias asignaciones" filtra esto por ti

if (coursesError) {
  console.error("Error al cargar asignaciones:", coursesError.message);
  return;
}

// Transformamos los datos para que el renderizado sea fÃ¡cil
// El resultado es un array de cursos con los datos de progreso incluidos
const courses = assignments 
  ? assignments.map(a => ({
      ...a.articles,     // id, title, thumbnail_url, etc.
      progress: a.progress, // 25, 60, etc.
      due_date: a.due_date  // "2025-11-20T..."
    })) 
  : [];

console.log("ğŸ“¦ Cursos asignados recibidos:", courses);
console.log("ğŸ“¦ Datos recibidos desde Supabase:", courses);
console.log("ğŸ” Error:", coursesError);

if (coursesError) {
  console.error("Error al cargar cursos:", coursesError.message);
} else {
  // Render de las tarjetas
  const container = document.getElementById("courseCardsContainer");

if (container) {
  console.log("ğŸ¨ Renderizando tarjetas con diseÃ±o de CSS existente", container);

  container.innerHTML = courses
    .map(c => {
      // c ahora tiene: { id, title, instructor_name, duration_text, progress, due_date }
      
      const dueDateInfo = getDueDateStatus(c.due_date);
      const progress = c.progress || 0;
      const isUrgent = dueDateInfo.urgent;

      // Determinamos quÃ© Ã­cono y color usar segÃºn el CSS
      // (.urgent, .completed, .pending)
      let iconClass = 'pending'; // Clase por defecto
      let iconFA = 'fa-clock';   // Ãcono por defecto
      
      if (isUrgent) {
          iconClass = 'urgent';
          iconFA = 'fa-exclamation-triangle';
      } else if (progress === 100) {
          iconClass = 'completed';
          iconFA = 'fa-check-circle';
      }

      return `
      <div class="course-card" data-status="${iconClass}">
          
          <div class="course-icon-lg ${iconClass}">
              <i class="fas ${iconFA}"></i>
          </div>

          <div class="course-info">
              <h3>${c.title}</h3>
              
              ${dueDateInfo.text ? `
              <div class="meta-item" style="font-size: 0.9rem; color: ${isUrgent ? 'var(--danger)' : 'var(--text-secondary)'}; font-weight: ${isUrgent ? '500' : 'normal'}; margin-bottom: 0.5rem;">
                  <i class="fas fa-calendar-alt"></i>
                  <span>${dueDateInfo.text}</span>
              </div>` : ''}

              <div class="course-meta" style="margin-bottom: 0.75rem;">
                  <div class="meta-item">
                      <i class="fas fa-user-tie"></i>
                      <span>Capacitador: ${c.instructor_name || 'N/A'}</span>
                  </div>
                  <div class="meta-item">
                      <i class="fas fa-clock"></i>
                      <span>${c.duration_text || 'N/A'}</span>
                  </div>
              </div>

              <div class="progress-bar-container">
                  <div class="progress-bar-fill" style="width: ${progress}%;"></div>
              </div>
              
              <p style="font-size: 0.85rem; color: var(--text-secondary); margin: 0.5rem 0 0 0;">
                  Progreso: ${progress}% completado
              </p>
          </div>

          <div class="course-actions">
            <a href="curso/curso.html?id=${c.id}" class="btn btn-primary" style="width: 100%;">
                ${progress > 0 ? 'Continuar' : 'Iniciar'}
            </a>
              <button class="btn btn-outline" style="width: 100%;">
                  Recordar
              </button>
          </div>
      </div>
      `;
    })
    .join("");
}
}

console.log('âœ… Cursos cargados');


Â  Â  initUI();
Â  Â  console.log('âœ… UI inicializada');
Â  }

Â  // --- Disparador de Carga ---
Â  if (document.readyState === 'loading') {
Â  Â  document.addEventListener('DOMContentLoaded', mainInit);
Â  } else {
Â  Â  mainInit();
Â  }

})();
</script>
</body>
</html>